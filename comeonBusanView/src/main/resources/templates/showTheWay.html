<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>부산 관광 지도</title>
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .busan-content {
    		flex-grow: 1;
   			 display: flex;
    		flex-direction: column;
    		padding-bottom: 40px; /* 전체 컨텐츠 영역의 하단 패딩 추가 */
}
        .busan-map-container {
            height: 500px;
            width: 100%;
            margin-top: 20px;
        }
        .busan-map {
            height: 100%;
            width: 100%;
        }
        .busan-info-container {
            flex-grow: 1;
            display: flex;
            margin-top: 20px;
        }
        .busan-list-section {
            flex: 1;
            margin: 0 10px;
        }
        .busan-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
        }
        .busan-card {
            margin-bottom: 10px;
        }
        .busan-card-img {
            max-height: 200px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <header>
        <th:block th:insert="~{/fragments/header2.html}"></th:block>
    </header>
    
    <div class="container busan-content">
        <div class="busan-map-container">
            <div id="busan-map" class="busan-map"></div>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <input id="busan-start" type="text" placeholder="출발지" class="form-control mb-2">
                <input id="busan-end" type="text" placeholder="도착지" class="form-control mb-2">
                <select id="busan-mode" class="form-select mb-2">
                    <option value="DRIVING">자동차</option>
                    <option value="TRANSIT">대중교통</option>
                    <option value="WALKING">도보</option>
                </select>
                <button onclick="calculateAndDisplayRoute()" class="btn btn-primary">경로 찾기</button>
                <button onclick="resetRoute()" class="btn btn-secondary">경로 초기화</button>
            </div>
            <div class="col-md-6">
                <div id="busan-directions-panel"></div>
            </div>
        </div>
        <div class="busan-info-container">
            <div id="busan-start-list" class="busan-list-section"></div>
            <div id="busan-arrow" class="busan-arrow"></div>
            <div id="busan-end-list" class="busan-list-section"></div>
        </div>
    </div>

    <footer>
        <th:block th:insert="~{/fragments/footer.html}"></th:block>
    </footer>

    <script>
    let map;
    let markers = [];
    let allData = {
        lodgment: [],
        food: [],
        tour: []
    };
    let directionsService;
    let directionsRenderer;
    let startSelected = false;

    function initMap() {
        const busan = { lat: 35.1796, lng: 129.0756 };
        map = new google.maps.Map(document.getElementById("busan-map"), {
            center: busan,
            zoom: 12,
        });

        const trafficLayer = new google.maps.TrafficLayer();
        trafficLayer.setMap(map);

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            panel: document.getElementById('busan-directions-panel')
        });

        loadLodgments();
        loadFoodData();
        loadTourData();
    }

    function loadLodgments() {
        $.ajax({
            url: "http://localhost:9002/lodgment/page",
            type: 'GET',
            data: {
                page: 1,
                size: 50
            },
            success: function(response) {
                allData.lodgment = response.content;
                response.content.forEach(item => {
                    if (item.위도 && item.경도) {
                        addMarker(item, 'lodgment');
                    }
                });
            },
            error: function(error) {
                console.error('Error fetching lodgments:', error);
            }
        });
    }

    function loadFoodData() {
        $.ajax({
            url: "http://localhost:9002/kibTest/food",
            method: "GET",
            success: function(response) {
                allData.food = response;
                response.forEach(item => {
                    if (item.lat && item.lng) {
                        addMarker(item, 'food');
                    }
                });
            },
            error: function(error) {
                console.error('Error fetching food data:', error);
            }
        });
    }

    function loadTourData() {
        $.ajax({
            url: "http://localhost:9002/kibTest/tourList",
            type: 'GET',
            success: function(response) {
                allData.tour = response;
                response.forEach(item => {
                    if (item.lat && item.lng) {
                        addMarker(item, 'tour');
                    }
                });
            },
            error: function(error) {
                console.error('Error fetching tour data:', error);
            }
        });
    }

    function addMarker(item, type) {
        let position;
        if (type === 'lodgment') {
            position = new google.maps.LatLng(item.위도, item.경도);
        } else {
            position = new google.maps.LatLng(item.lat, item.lng);
        }
        
        const marker = new google.maps.Marker({
            position: position,
            map: map,
            icon: getMarkerIcon(type)
        });

        marker.addListener('click', () => {
            showInfo(item, type);
        });

        markers.push(marker);
    }

    function getMarkerIcon(type) {
        switch(type) {
            case 'lodgment':
                return 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png';
            case 'food':
                return 'http://maps.google.com/mapfiles/ms/icons/red-dot.png';
            case 'tour':
                return 'http://maps.google.com/mapfiles/ms/icons/green-dot.png';
            default:
                return 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png';
        }
    }

    function showInfo(item, type) {
        let content = '';
        if (type === 'lodgment') {
            content = `
                <div class="busan-card card">
                    <div class="card-body">
                        <h5 class="card-title">${item.업체명}</h5>
                        <p class="card-text">${item.카테고리명}</p>
                        <p class="card-text">주소: ${item.시도명} ${item.시군구명} ${item.읍면동명} ${item.리명} ${item.번지}</p>
                        <p class="card-text">전화번호: ${item.전화번호}</p>
                    </div>
                </div>
            `;
        } else if (type === 'food' || type === 'tour') {
            content = `
                <div class="busan-card card">
                    <img src="${item.main_img_thumb}" class="card-img-top busan-card-img" alt="${item.maintitle}">
                    <div class="card-body">
                        <h5 class="card-title">${item.title}</h5>
                        <p class="card-text">${item.maintitle}</p>
                    </div>
                </div>
            `;
        }

        if (!startSelected) {
            content += `<button onclick="selectStart('${type}', ${item.id})" class="btn btn-primary">출발지로 선택</button>`;
            $('#busan-start-list').html(content);
        } else {
            content += `<button onclick="selectEnd('${type}', ${item.id})" class="btn btn-primary">도착지로 선택</button>`;
            $('#busan-end-list').html(content);
            $('#busan-arrow').html('→');
        }
    }

    function selectStart(type, id) {
        const item = allData[type].find(i => i.id === id);
        document.getElementById('busan-start').value = item.title || item.업체명;
        startSelected = true;
    }

    function selectEnd(type, id) {
        const item = allData[type].find(i => i.id === id);
        document.getElementById('busan-end').value = item.title || item.업체명;
    }

    function calculateAndDisplayRoute() {
        const start = document.getElementById('busan-start').value;
        const end = document.getElementById('busan-end').value;
        const mode = document.getElementById('busan-mode').value;

        directionsService.route(
            {
                origin: start,
                destination: end,
                travelMode: google.maps.TravelMode[mode],
                provideRouteAlternatives: true,
                drivingOptions: {
                    departureTime: new Date(Date.now() + 10 * 60 * 1000),  // 10분 후 출발
                    trafficModel: 'bestguess'
                }
            },
            function(response, status) {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                    showRouteDetails(response);
                } else {
                    window.alert('경로를 찾을 수 없습니다: ' + status);
                }
            }
        );
    }

    function showRouteDetails(response) {
        const routes = response.routes;
        let detailsHtml = '<h3>경로 상세 정보</h3>';

        routes.forEach((route, index) => {
            const leg = route.legs[0]; // 출발지에서 도착지까지의 단일 구간
            detailsHtml += `
                <div class="route-detail">
                    <h4>경로 ${index + 1}</h4>
                    <p>총 거리: ${leg.distance.text}</p>
                    <p>예상 소요 시간: ${leg.duration.text}</p>
                    <p>교통 상황 반영 시간: ${leg.duration_in_traffic ? leg.duration_in_traffic.text : '정보 없음'}</p>
                </div>
            `;
        });

        $('#busan-directions-panel').html(detailsHtml);
    }

    function resetRoute() {
        directionsRenderer.setDirections({routes: []});
        document.getElementById('busan-start').value = '';
        document.getElementById('busan-end').value = '';
        document.getElementById('busan-start-list').innerHTML = '';
        document.getElementById('busan-end-list').innerHTML = '';
        document.getElementById('busan-arrow').innerHTML = '';
        $('#busan-directions-panel').html('');
        startSelected = false;
    }

    window.initMap = initMap;
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1VqsvOxs4dsglMk3wCxxB-_y58G3zyzU&callback=initMap&libraries=places" defer></script>
</body>
</html>