<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>부산 관광 지도</title>
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <style>
    .custom-body, .custom-html {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: 'Arial', sans-serif;
        background-color: #e6f3ff;
    }
    .custom-container-fluid {
        height: calc(100vh - 56px);
        padding: 20px;
        display: flex;
        justify-content: center;
    }
    .custom-content-wrapper {
        display: flex;
        width: 100%;
        max-width: 1400px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .custom-controls-container {
        width: 250px;
        padding: 20px;
        background-color: #1e90ff;
        color: white;
    }
    .custom-map-container {
        flex-grow: 1;
        height: calc(100vh - 96px);
    }
    #busan-map {
        width: 100%;
        height: 100%;
    }
    #busan-directions-panel {
        width: 300px;
        padding: 20px;
        background-color: #f0f8ff;
    }
    .custom-form-control, .custom-form-select {
        margin-bottom: 10px;
        border: none;
        border-radius: 5px;
    }
    .custom-btn {
        width: 100%;
        margin-bottom: 10px;
        border: none;
        border-radius: 5px;
    }
    .custom-btn-primary, .custom-btn-secondary, .busan-card-button {
        background-color: #00a8e8;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .custom-btn-primary:hover, .custom-btn-secondary:hover, .busan-card-button:hover {
        background-color: #0086ba;
    }
    .custom-h3 {
        color: white;
        border-bottom: 2px solid white;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .gm-style-iw {
        max-width: 300px !important;
        max-height: 400px !important;
        padding: 0 !important;
    }
    .gm-style-iw-d {
        overflow: hidden !important;
        padding: 0 !important;
    }
    .busan-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
        width: 100%;
        margin: 0;
        box-sizing: border-box;
    }
    .busan-card-img {
        width: 100%;
        max-width: 180px;
        height: 135px;
        object-fit: cover;
        border-radius: 5px;
        margin-bottom: 10px;
    }
    .busan-card-body {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        text-align: center;
    }
    .busan-card-title {
        margin: 5px 0;
        font-size: 1.1em;
        font-weight: bold;
    }
    .busan-card-text {
        margin-bottom: 10px;
    }
    .busan-card-button {
    width: 90%;
    margin: 5px 0;
    background-color: #00a8e8;
    color: white;
    border: none !important;
    border-radius: 5px;
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    vertical-align: middle;
    user-select: none;
    line-height: 1.5;
    box-shadow: none !important;
}
.busan-card-button:hover,
.busan-card-button:focus,
.busan-card-button:active {
    background-color: #0086ba;
    color: white;
    text-decoration: none;
    outline: none;
    box-shadow: none !important;
}
    #map-legend {
        position: absolute;
        bottom: 30px;
        left: 10px;
        background: white;
        padding: 10px;
        border: 1px solid #999;
        border-radius: 5px;
        font-size: 12px;
        z-index: 1000;
    }
    #map-legend div {
        margin-bottom: 5px;
        display: flex;
        align-items: center;
    }
    #map-legend img {
        width: 20px;
        height: 20px;
        margin-right: 5px;
    }
</style>
</head>
<body class="custom-body">
    <header>
        <th:block th:insert="~{/fragments/header2.html}"></th:block>
    </header>
    
    <div class="custom-container-fluid">
        <div class="custom-content-wrapper">
            <div class="custom-controls-container">
                <h3 class="custom-h3">경로 찾기</h3>
                <input id="busan-start" type="text" placeholder="출발지" class="form-control custom-form-control">
                <input id="busan-end" type="text" placeholder="도착지" class="form-control custom-form-control">
                <select id="busan-mode" class="form-select custom-form-select">
                    <option value="TRANSIT">대중교통</option>
                </select>
                <button onclick="calculateAndDisplayRoute()" class="btn custom-btn custom-btn-primary">경로 찾기</button>
                <button onclick="resetRoute()" class="btn custom-btn custom-btn-secondary">경로 초기화</button>
            </div>
            <div class="custom-map-container">
                <div id="busan-map"></div>
            </div>
            <div id="busan-directions-panel" style="display: none;"></div>
        </div>
    </div>

    <footer>
        <th:block th:insert="~{/fragments/footer.html}"></th:block>
    </footer>

    <script>
    let map;
    let markers = [];
    let allData = {
        lodgment: [],
        food: [],
        tour: []
    };
    let directionsService;
    let directionsRenderer;
    let startSelected = false;
    let infoWindow;

    function initMap() {
        const busan = { lat: 35.1796, lng: 129.0756 };
        map = new google.maps.Map(document.getElementById("busan-map"), {
            center: busan,
            zoom: 12,
            language: 'ko'
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            panel: null
        });

        infoWindow = new google.maps.InfoWindow();

        loadLodgments();
        loadFoodData();
        loadTourData();
        createLegend();
    }

    function createLegend() {
        const legend = document.createElement('div');
        legend.id = 'map-legend';
        const items = [
            { type: 'lodgment', label: '숙박', color: 'blue' },
            { type: 'food', label: '음식점', color: 'red' },
            { type: 'tour', label: '관광지', color: 'green' }
        ];

        items.forEach(item => {
            const div = document.createElement('div');
            div.innerHTML = `
                <img src="http://maps.google.com/mapfiles/ms/icons/${item.color}-dot.png" alt="${item.label}">
                <span>${item.label}</span>
            `;
            legend.appendChild(div);
        });

        map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(legend);
    }

    function loadLodgments() {
        $.ajax({
            url: "http://localhost:9002/lodgment/page",
            type: 'GET',
            data: {
                page: 1,
                size: 100
            },
            success: function(response) {
                console.log("Lodgment data loaded:", response);
                allData.lodgment = response.content;
                response.content.forEach(item => {
                    if (item.위도 && item.경도) {
                        addMarker(item, 'lodgment');
                    }
                });
            },
            error: function(error) {
                console.error('Error fetching lodgments:', error);
            }
        });
    }

    function loadFoodData() {
        $.ajax({
            url: "http://localhost:9002/kibTest/food",
            method: "GET",
            success: function(response) {
                console.log("Food data loaded:", response);
                allData.food = response;
                response.forEach(item => {
                    if (item.lat && item.lng) {
                        addMarker(item, 'food');
                    }
                });
            },
            error: function(error) {
                console.error('Error fetching food data:', error);
            }
        });
    }

    function loadTourData() {
        $.ajax({
            url: "http://localhost:9002/kibTest/tourList",
            type: 'GET',
            success: function(response) {
                console.log("Tour data loaded:", response);
                allData.tour = response;
                response.forEach(item => {
                    if (item.lat && item.lng) {
                        addMarker(item, 'tour');
                    }
                });
            },
            error: function(error) {
                console.error('Error fetching tour data:', error);
            }
        });
    }

    function addMarker(item, type) {
        let position;
        if (type === 'lodgment') {
            position = new google.maps.LatLng(item.위도, item.경도);
        } else {
            position = new google.maps.LatLng(parseFloat(item.lat), parseFloat(item.lng));
        }
        
        console.log(`Adding marker for ${type}:`, position);

        const marker = new google.maps.Marker({
            position: position,
            map: map,
            icon: getMarkerIcon(type)
        });

        marker.addListener('click', () => {
            showInfo(item, type, marker);
        });

        markers.push(marker);
    }

    function getMarkerIcon(type) {
        switch(type) {
            case 'lodgment':
                return 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png';
            case 'food':
                return 'http://maps.google.com/mapfiles/ms/icons/red-dot.png';
            case 'tour':
                return 'http://maps.google.com/mapfiles/ms/icons/green-dot.png';
            default:
                return 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png';
        }
    }

    function showInfo(item, type, marker) {
        let content = '';
        let name, lat, lng;
        
        if (type === 'lodgment') {
            name = item.업체명;
            lat = item.위도;
            lng = item.경도;
            content = `
                <div class="busan-card card">
                    <div class="busan-card-body">
                        <h5 class="busan-card-title">${name}</h5>
                        <button onclick="selectLocation('start', '${name} (${lat}, ${lng})')" class="btn btn-sm busan-card-button">출발지로 선택</button>
                        <button onclick="selectLocation('end', '${name} (${lat}, ${lng})')" class="btn btn-sm busan-card-button">도착지로 선택</button>
                    </div>
                </div>
            `;
        } else if (type === 'food' || type === 'tour') {
            name = type === 'tour' ? item.place : (item.main_title || item.maintitle || '이름 없음');
            lat = item.lat;
            lng = item.lng;
            content = `
                <div class="busan-card card">
                    <img src="${item.main_img_thumb || '#'}" class="busan-card-img" alt="${name}">
                    <div class="busan-card-body">
                        <h5 class="busan-card-title">${name}</h5>
                        <button onclick="selectLocation('start', '${name} (${lat}, ${lng})')" class="btn btn-sm busan-card-button">출발지로 선택</button>
                        <button onclick="selectLocation('end', '${name} (${lat}, ${lng})')" class="btn btn-sm busan-card-button">도착지로 선택</button>
                    </div>
                </div>
            `;
        }

        console.log(`Showing info for ${type}:`, item);

        infoWindow.setContent(content);
        infoWindow.open(map, marker);
    }

    function selectLocation(type, info) {
        if (type === 'start') {
            document.getElementById('busan-start').value = info;
            startSelected = true;
        } else {
            document.getElementById('busan-end').value = info;
        }
        infoWindow.close();
    }

    function calculateAndDisplayRoute() {
        const start = document.getElementById('busan-start').value;
        const end = document.getElementById('busan-end').value;
        const mode = document.getElementById('busan-mode').value;

        const startCoords = extractCoordinates(start);
        const endCoords = extractCoordinates(end);

        if (!startCoords || !endCoords) {
            window.alert('올바른 출발지와 도착지를 선택해주세요.');
            return;
        }

        directionsService.route(
            {
                origin: startCoords,
                destination: endCoords,
                travelMode: google.maps.TravelMode[mode],
                provideRouteAlternatives: false
            },
            function(response, status) {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                    showRouteDetails(response);
                    adjustLayout();
                } else {
                    window.alert('경로를 찾을 수 없습니다: ' + status);
                }
            }
        );
    }

    function extractCoordinates(value) {
        const match = value.match(/\(([-\d.]+),\s*([-\d.]+)\)/);
        return match ? new google.maps.LatLng(parseFloat(match[1]), parseFloat(match[2])) : null;
    }

    function showRouteDetails(response) {
        const route = response.routes[0];
        let detailsHtml = '<h3>대중교통 경로 정보</h3>';

        const leg = route.legs[0];
        detailsHtml += `
            <div class="route-detail">
                <p><strong>출발:</strong> ${leg.start_address}</p>
                <p><strong>도착:</strong> ${leg.end_address}</p>
                <p><strong>총 거리:</strong> ${leg.distance.text}</p>
                <p><strong>예상 소요 시간:</strong> ${leg.duration.text}</p>
                <h4>상세 경로:</h4>
                <ol>
        `;

        leg.steps.forEach((step, index) => {
            if (step.travel_mode === "TRANSIT") {
                const vehicle = step.transit.line.vehicle.name;
                const line = step.transit.line.short_name || step.transit.line.name;
                const departureTime = new Date(step.transit.departure_time.value);
                const arrivalTime = new Date(step.transit.arrival_time.value);
                
                detailsHtml += `
                    <li>
                        <strong>${vehicle} - ${line}</strong><br>
                        출발: ${departureTime.toLocaleTimeString()} (${step.transit.departure_stop.name})<br>
                        도착: ${arrivalTime.toLocaleTimeString()} (${step.transit.arrival_stop.name})<br>
                        소요 시간: ${step.duration.text}
                    </li>
                `;
            } else {
                detailsHtml += `
                    <li>
                        ${step.instructions} (${step.distance.text}, ${step.duration.text})
                    </li>
                `;
            }
        });

        detailsHtml += '</ol></div>';

        $('#busan-directions-panel').html(detailsHtml).css('overflow-y', 'hidden').show();
    }

    function adjustLayout() {
        $('#busan-directions-panel').show();
    }

    function resetRoute() {
        directionsRenderer.setDirections({routes: []});
        document.getElementById('busan-start').value = '';
        document.getElementById('busan-end').value = '';
        $('#busan-directions-panel').hide();
        startSelected = false;
    }
    
    function googleMapAPI(){
    	 const script = document.createElement('script');
    	 script.src= '/proxy/maps-api?callback=initMap&libraries=places&language=ko';
    	 script.defer = true;
    	 document.head.appendChild(script);
    }

    window.initMap = initMap;
    </script>
	<script>
		document.addEventListener('DOMContentLoaded', googleMapAPI);
	</script>
</body>
</html>