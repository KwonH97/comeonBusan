<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>위험 지역 알림 시스템</title>
    <style>
        #map { height: 400px; width: 100%; }
        #danger-list { margin-top: 20px; }
        .danger-item { padding: 10px; margin: 10px 0; border: 1px solid #ddd; cursor: pointer; }
    </style>
</head>
<body>
    <header>
        <th:block th:insert="~{/fragments/header2.html}"></th:block>
    </header>

    <h1>위험 지역 알림 시스템</h1>
    <div id="map"></div>
    <div id="user-controls">
        <h4>사용자 위치</h4>
        <p id="current-location">위도: -, 경도: -</p>
        <p>지도를 클릭하여 사용자 위치를 변경하세요.</p>
    </div>
    <div id="danger-list"></div>

    <footer>
        <th:block th:insert="~{/fragments/footer.html}"></th:block>
    </footer>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1VqsvOxs4dsglMk3wCxxB-_y58G3zyzU"></script>
    <script>
        var map;
        var userMarker;
        var userCircle;
        var dangerZones = [
            { name: "위험 구역 1", type: "circle", center: {lat: 35.1796, lng: 129.0656}, radius: 100 },
            { name: "위험 구역 2", type: "circle", center: {lat: 35.1696, lng: 129.0756}, radius: 150 },
            { name: "위험 지역 1", type: "polygon", coords: [
                {lat: 35.1846, lng: 129.0706},
                {lat: 35.1826, lng: 129.0726},
                {lat: 35.1806, lng: 129.0706},
                {lat: 35.1826, lng: 129.0686}
            ]},
            { name: "위험 지역 2", type: "polygon", coords: [
                {lat: 35.1746, lng: 129.0806},
                {lat: 35.1726, lng: 129.0826},
                {lat: 35.1706, lng: 129.0806},
                {lat: 35.1726, lng: 129.0786}
            ]}
        ];

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 14,
                center: {lat: 35.1796, lng: 129.0756}
            });

            userMarker = new google.maps.Marker({
                position: {lat: 35.1796, lng: 129.0756},
                map: map,
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                },
                title: "사용자 위치",
                draggable: true
            });

            userCircle = new google.maps.Circle({
                strokeColor: "#0000FF",
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: "#0000FF",
                fillOpacity: 0.35,
                map: map,
                center: userMarker.getPosition(),
                radius: 100
            });

            map.addListener('click', function(e) {
                updateUserLocation(e.latLng);
            });

            userMarker.addListener('dragend', function(e) {
                updateUserLocation(e.latLng);
            });

            displayDangerZones();
            updateLocationDisplay(userMarker.getPosition());
        }

        function updateUserLocation(latLng) {
            userMarker.setPosition(latLng);
            userCircle.setCenter(latLng);
            updateLocationDisplay(latLng);
            checkDangerZones(latLng);
        }

        function updateLocationDisplay(position) {
            document.getElementById('current-location').textContent = 
                `위도: ${position.lat().toFixed(6)}, 경도: ${position.lng().toFixed(6)}`;
        }

        function displayDangerZones() {
            dangerZones.forEach(function(zone) {
                if (zone.type === "circle") {
                    new google.maps.Circle({
                        strokeColor: "#FF0000",
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: "#FF0000",
                        fillOpacity: 0.35,
                        map: map,
                        center: zone.center,
                        radius: zone.radius
                    });
                } else if (zone.type === "polygon") {
                    new google.maps.Polygon({
                        paths: zone.coords,
                        strokeColor: "#FF0000",
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: "#FF0000",
                        fillOpacity: 0.35,
                        map: map
                    });
                }
            });

            updateDangerList();
        }

        function updateDangerList() {
            var list = document.getElementById('danger-list');
            list.innerHTML = '<h3>위험 지역 목록</h3>';
            dangerZones.forEach(function(zone) {
                var item = document.createElement('div');
                item.className = 'danger-item';
                item.textContent = zone.name;
                item.onclick = function() {
                    if (zone.type === "circle") {
                        map.setCenter(zone.center);
                    } else if (zone.type === "polygon") {
                        map.setCenter(zone.coords[0]);
                    }
                    map.setZoom(15);
                };
                list.appendChild(item);
            });
        }

        function checkDangerZones(position) {
            dangerZones.forEach(function(zone) {
                if (zone.type === "circle") {
                    if (google.maps.geometry.spherical.computeDistanceBetween(position, new google.maps.LatLng(zone.center)) <= zone.radius) {
                        alert(`주의! ${zone.name}에 접근했습니다.`);
                    }
                } else if (zone.type === "polygon") {
                    var poly = new google.maps.Polygon({paths: zone.coords});
                    if (google.maps.geometry.poly.containsLocation(position, poly)) {
                        alert(`주의! ${zone.name}에 들어왔습니다.`);
                    }
                }
            });
        }

        initMap();
    </script>
</body>
</html>
