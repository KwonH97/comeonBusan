<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ïò®ÎÇòÎ∂ÄÏÇ∞ - Main</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Dongle&display=swap" rel="stylesheet">
<script src="/js/notifications.js"></script>
<style>
body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    margin: 0;
    padding: 0;
}

main {
    flex: 1;
    padding: 20px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
}

a {
    text-decoration-line: none;
    color: black;
}

.content-header {
    text-align: center;
    margin-bottom: 20px;
}

#weather-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    width: 90%;
    margin: 20px;
}

.weather-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    width: 140px;
    text-align: center;
}

.weather-card h3 {
    margin: 0 0 5px 0;
    font-size: 1.2em;
}

.weather-icon {
    font-size: 1.5em;
}

.weather-temp {
    font-size: 1em;
}

#container, #upcoming-festival-container, #middle {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    width: 90%;
}

#current-festival-container {
    display: flex;
    flex-wrap: nowrap;
    justify-content: left;
    gap: 20px;
}

.tour-item {
    width: 23%;
    box-sizing: border-box;
    text-align: center;
    border: 1px solid #ccc;
    padding: 10px;
    background-color: #f9f9f9;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.tour-title {
    font-weight: bold;
    margin: 10px 0;
}

.tour-thumbnail {
    width: 100%;
    height: auto;
    max-width: 250px;
}

.upcoming-label {
    background-color: #ffd700;
    color: #000;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 5px;
    margin-top: 10px;
    display: inline-block;
    animation: blink 1s infinite;
}

@keyframes blink {
    0% {
        background-color: #ff6600;
    }
    50% {
        background-color: #ff9900;
    }
    100% {
        background-color: #ff6600;
    }
}

footer {
    background-color: #f1f1f1;
    text-align: center;
    padding: 10px;
}

.section-title {
    width: 100%;
    text-align: center;
    font-size: 50px;
    margin: 20px 0;
    font-family: "Dongle", sans-serif;
    font-weight: 300;
}

#load {
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    position: fixed;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0.8;
    background: white;
    z-index: 99;
    text-align: center;
}

#load>img {
    position: relative;
}

#middle {
    display: flex;
    flex-wrap: nowrap;
    box-sizing: border-box;
}

#festival-container, #notice-container {
    display: flex;
    flex-direction: column;
    width: 50%;
    height: 100%;
}

#festival-container>div, #notice-container>div {
    flex: 1;
}

#festival-title, #notice-title {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 20px;
    box-sizing: border-box;
    padding: 0 10px;
    padding-top: 20px;
    padding-bottom: 20px;
    position: relative;
}

#festival-title h2, #notice-title h2 {
    margin: 0;
    font-family: "Dongle", sans-serif;
    font-weight: 300;
    font-size: 50px;
}

.more-button {
    display: flex;
    background-color: white;
    color: black;
    padding: 5px 10px;
    border: none;
    border-radius: 5px solid black;
    text-decoration: none;
    font-size: 0.9em;
    position: absolute;
    right: 0;
}

.upcoming-tour-thumbnail {
    width: 247.5px;
    height: 193.922px;
}

.photo-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
}

.photo-item {
    margin: 10px;
    text-align: center;
}

.photo-thumbnail {
    width: 250px;
    height: 200px;
    object-fit: cover;
}

.photo-title {
    margin-top: 5px;
}

#youtubeView {
    background-color: #dcd0ff;
    color: black;
    padding-top: 20px;
    padding-bottom: 20px;
    text-align: center;
    max-width: 1200px;
    margin: 0 auto;
    border-radius: 15px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.button-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 20px;
}

#prevBtn, #nextBtn {
    background-color: #0055a5;
    border: none;
    color: white;
    padding: 10px 20px;
    cursor: pointer;
    margin: 0 10px;
}

#prevBtn:hover, #nextBtn:hover {
    background-color: #0073e6;
}

.dots {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 10px;
}

.dot {
    height: 10px;
    width: 10px;
    margin: 0 5px;
    background-color: #bbb;
    border-radius: 50%;
    display: inline-block;
}

.active {
    background-color: #717171;
}

#youtubeView {
    width: 100%;
    margin-top: 20px;
    margin-bottom: 20px;
}

.hiddenButton {
    background-color: #5DADE2;
    color: white;
    border: none;
    border-radius: 12px;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
    text-align: center;
    margin: 5px;
}

.hiddenbutton:hover {
    background-color: #3498db;
    color: white;
}

#goPlist {
    background-color: #5DADE2;
}

/* ÎØ∏ÎîîÏñ¥ ÏøºÎ¶¨ */
@media (max-width: 1200px) {
    .section-title {
        font-size: 40px;
    }
    .tour-item {
        width: 45%;
    }
}

@media (max-width: 768px) {
    .section-title {
        font-size: 30px;
    }
    .tour-item {
        width: 90%;
    }
    #festival-container, #notice-container {
        width: 100%;
    }
}

@media (max-width: 576px) {
    .section-title {
        font-size: 25px;
    }
    .tour-item {
        width: 100%;
    }
    .weather-card {
        width: 100%;
    }
    #youtubeView {
        padding: 10px;
    }
    .more-button {
        font-size: 0.8em;
        padding: 3px 7px;
    }
}
</style>
<script src="https://code.jquery.com/jquery-3.7.1.js"
    integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
    crossorigin="anonymous"></script>
</head>
<body>

    <div id="load">
        <img src="/img/travel.gif" alt="loading">
    </div>
    <!-- loading.gif -->
    <header>
        <th:block th:insert="~{/fragments/header2.html}"></th:block>
    </header>

    <main>
        <div id="weather-container" class="weather-container"></div>
        <h2 class="section-title">ÌòÑ ÏúÑÏπò Ï£ºÎ≥Ä Í¥ÄÍ¥ëÏßÄ</h2>
        <div id="container"></div>
        <div id="middle">
            <div id="festival-container">
                <!-- left -->
                <div id="festival-title">
                    <h2>ÌòÑÏû¨ ÏßÑÌñâÏ§ëÏù∏ ÌñâÏÇ¨</h2>
                </div>
                <div id="current-festival-container"></div>
            </div>
            <div id="notice-container">
                <!-- right -->
                <div id="notice-title">
                    <h2>Í≥µÏßÄÏÇ¨Ìï≠</h2>
                    <a href="/notice/noticeList" class="more-button">ÎçîÎ≥¥Í∏∞</a>
                </div>
                <div id="notice-content-container">
                    <table id="notice-table">
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <h2 class="section-title">Ï∂ïÏ†ú ÏòàÏ†ï</h2>
        <div id="upcoming-festival-container"></div>
        
        <div id="youtubeView">
            <h2 class="section-title">Î∂ÄÏÇ∞ ÌôçÎ≥¥ ÏòÅÏÉÅ</h2>
            <div id="video-container"></div>
            <div class="button-container">
                <button id="prevBtn"> Ïù¥Ï†Ñ </button>
                <div class="dots" id="dots-container"></div>
                <button id="nextBtn"> Îã§Ïùå </button>
            </div>
        </div>
        
        <div id="photo-area">
            <div id="photo-head">
                <span class="section-title">ÏÇ¨ÏßÑÍ¥Ä</span> <a href="/photoList"><span id="goPlist">ÏÇ¨ÏßÑ Î™©Î°ùÏúºÎ°ú</span></a>
            </div>
            <div id="photo-container" class="photo-container"></div>
        </div>
    </main>

    <footer>
        <th:block th:insert="~{/fragments/footer.html}"></th:block>
    </footer>

    <script>

    $(window).on('load', function() { 
        // Î°úÎî© Ïù¥ÎØ∏ÏßÄÎ•º 3Ï¥à ÌõÑÏóê Ïà®ÍπÄ
        setTimeout(function() {
            $('#load').fadeOut();
        }, 1000); // 1000ms = 1Ï¥à
    });
    
    var videoIds = ['o_FlQvFotwQ', 'NfdCTa3r1DA', 'QGrnMdi6wrQ', '3gugFrmfhlQ'];
    var currentIndex = 0;
    var player;

    // Ïú†ÌäúÎ∏å iframe API Ï§ÄÎπÑ
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('video-container', {
            height: '450',
            width: '900',
            videoId: videoIds[currentIndex],
            playerVars: {
                'autoplay': 0,
                'controls': 1,
                'rel': 0,
                'showinfo': 0
            }
        });
        updateDots();
    }

    function loadVideo(index) {
        if (player) {
            player.stopVideo();
            player.cueVideoById({
                    videoId: videoIds[index],
                    startSeconds: 0        
            });
           updateDots(); 
            
        }
    }
    
    function updateDots() {
        $('#dots-container').empty();
        videoIds.forEach(function(_, index){
            var dot = $('<div>').addClass('dot').attr('data-index', index);
            if (index === currentIndex) {
                dot.addClass('active');
            }
            $('#dots-container').append(dot);
        });
    }
    
    $(document).ready(function() {
                
        let tourData = [];
        let festivalData = [];

        // IP Í∏∞Î∞ò ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§Îäî Ìï®Ïàò
        function getLocationByIP() {
            $.ajax({
                url: "/proxy/ipToken", // Ïó¨Í∏∞ÏóêÏÑú YOUR_API_TOKENÏùÑ Ïã§Ï†ú ipinfo.io API ÌÜ†ÌÅ∞ÏúºÎ°ú Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî.
                type: 'GET',
                success: function(response) {
                    const loc = response.loc.split(',');
                    const lat = parseFloat(loc[0]);
                    const lon = parseFloat(loc[1]);
                    showPosition(lat, lon);
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching IP location:", error);
                }
            });
        }

        getLocationByIP();

        // Î∂ÄÏÇ∞Ïùò ÌïòÎìúÏΩîÎî©Îêú ÏúÑÎèÑÏôÄ Í≤ΩÎèÑ
        const busanLat = 35.1796;
        const busanLon = 129.0756;

        // Î∂ÄÏÇ∞Ïùò ÎÇ†Ïî® Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§Îäî Ìï®Ïàò
        function getBusanWeather() {
            const weatherUrl = `/proxy/main-weather-api?lat=${busanLat}&lon=${busanLon}`;

            const weatherMapping = {
                'clear sky': 'ÎßëÏùå',
                'few clouds': 'ÎßëÏùå',
                'scattered clouds': 'ÎßëÏùå',
                'broken clouds': 'ÌùêÎ¶º',
                'overcast clouds': 'ÌùêÎ¶º',
                'light rain': 'ÎπÑ',
                'moderate rain': 'ÎπÑ',
                'heavy intensity rain': 'ÎπÑ',
                'shower rain': 'ÎπÑ',
                'rain': 'ÎπÑ',
                'thunderstorm': 'ÎπÑ',
                'snow': 'Îàà',
                'mist': 'ÏïàÍ∞ú',
                'fog': 'ÏïàÍ∞ú',
                'haze': 'ÏïàÍ∞ú',
                'smoke': 'ÏïàÍ∞ú',
                'dust': 'ÏïàÍ∞ú',
                'sand': 'ÏïàÍ∞ú',
                'ash': 'ÏïàÍ∞ú',
                'squalls': 'ÎπÑ',
                'tornado': 'ÎπÑ'
            };

            const weatherIcons = {
                'ÎßëÏùå': '‚òÄÔ∏è',
                'ÌùêÎ¶º': '‚òÅÔ∏è',
                'ÎπÑ': 'üåßÔ∏è',
                'Îàà': '‚ùÑÔ∏è',
                'ÏïàÍ∞ú': 'üå´Ô∏è'
            };

            fetch(weatherUrl)
                .then(response => response.json())
                .then(data => {
                    const weatherForecast = data.list;
                    const weatherContainer = document.getElementById('weather-container');
                    let content = '';

                    const days = {};

                    weatherForecast.forEach(forecast => {
                        const date = forecast.dt_txt.split(' ')[0];
                        const tempMin = (forecast.main.temp_min - 273.15).toFixed(2);
                        const tempMax = (forecast.main.temp_max - 273.15).toFixed(2);
                        const description = forecast.weather[0].description;
                        const simplifiedDescription = weatherMapping[description] || 'ÎßëÏùå';
                        const icon = weatherIcons[simplifiedDescription] || '‚òÄÔ∏è';

                        if (!days[date]) {
                            days[date] = {
                                tempsMin: [],
                                tempsMax: [],
                                descriptions: new Set(),
                                icons: new Set()
                            };
                        }
                        days[date].tempsMin.push(parseFloat(tempMin));
                        days[date].tempsMax.push(parseFloat(tempMax));
                        days[date].descriptions.add(simplifiedDescription);
                        days[date].icons.add(icon);
                    });

                    for (const [date, data] of Object.entries(days)) {
                        const minTemp = Math.min(...data.tempsMin).toFixed(2);
                        const maxTemp = Math.max(...data.tempsMax).toFixed(2);
                        const icon = Array.from(data.icons).join(' ');

                        content += `
                            <div class="weather-card">
                                <h3>${date}</h3>
                                <div class="weather-icon">${icon}</div>
                                <div class="weather-temp">ÏµúÏ†Ä: ${minTemp}¬∞C<br>ÏµúÍ≥†: ${maxTemp}¬∞C</div>
                            </div>
                        `;
                    }

                    weatherContainer.innerHTML = content;
                })
                .catch(error => console.error('Error fetching weather data:', error));
        }

        getBusanWeather();

        function showPosition(lat, lon) {
            $.ajax({
                url: "http://localhost:9002/kibTest/tourList",
                type: 'GET',
                success: function(response) {
                    tourData = response;
                    tourData.forEach(item => {
                        item.distance = calculateDistance(lat, lon, item.latitude, item.longitude);
                    });
                    tourData.sort((a, b) => a.distance - b.distance);
                    const nearestTours = tourData.slice(0, 8);
                    renderTours(nearestTours);
                },
                error: function(xhr, status, error) {
                    console.error("Error loading tours:", error);
                }
            });

            $.ajax({
                url: "http://localhost:9002/khj/festival",
                type: 'GET',
                success: function(response) {
                    console.log("Ï∂ïÏ†ú Îç∞Ïù¥ÌÑ∞:", response);
                    festivalData = response;
                    processFestivals(festivalData);
                },
                error: function(xhr, status, error) {
                    console.error("Error loading festivals:", error);
                }
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c;
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        function processFestivals(festivals) {
            const currentDate = new Date().toISOString().split('T')[0];
            const currentFestivals = [];
            const upcomingFestivals = [];

            festivals.forEach(festival => {
                const startDate = festival.startDate ? festival.startDate.split('T')[0] : null;
                const endDate = festival.endDate ? festival.endDate.split('T')[0] : null;

                if (startDate && endDate) {
                    if (currentDate >= startDate && currentDate <= endDate) {
                        currentFestivals.push(festival);
                    } else if (currentDate < startDate) {
                        upcomingFestivals.push(festival);
                    }
                }
            });

            currentFestivals.sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
            upcomingFestivals.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            renderFestivals(currentFestivals.slice(0, 4), '#current-festival-container');
            renderFestivals(upcomingFestivals.slice(0, 4), '#upcoming-festival-container', true);
        }

        function renderTours(tours) {
            $('#container').empty();
            tours.forEach(item => {
                const tourItem = `
                    <div class="tour-item">
                        <div class="tour-title">${item.title}</div>
                        <a href="/tourDetail?uc_seq=${item.uc_seq}">
                            <img class="tour-thumbnail" src="${item.main_img_thumb}" alt="${item.title}">
                        </a>
                    </div>
                `;
                $('#container').append(tourItem);
            });
        }

        function renderFestivals(festivals, containerId, isUpcoming = false) {
            $(containerId).empty();
            
            if(isUpcoming){
                
                festivals.forEach(item => {
                    const festivalItem = `
                        <div class="tour-item">
                            <div class="tour-title">${item.title}</div>
                            <p>${item.startDate.split('T')[0]} ~ ${item.endDate.split('T')[0]}</p>
                            <a href="/festivalDetail?uc_seq=${item.ucSeq}">
                                <img class="tour-thumbnail" src="${item.mainImgThumb}" alt="${item.title}">
                            </a>
                           <div class="upcoming-label">Ï∂ïÏ†ú ÏòàÏ†ï</div>
                        </div>
                    `;
                    $(containerId).append(festivalItem);
                });
                
                
            }else {
                
                festivals.forEach(item => {
                    const festivalItem = `
                        <div class="upcoming-festival-item">
                            <a href="/festivalDetail?uc_seq=${item.ucSeq}">
                                <img class="upcoming-tour-thumbnail" src="${item.mainImgThumb}" alt="${item.title}">
                            </a>                           
                            <div class="upcoming-tour-title">${item.title}</div>
                            <p>${item.startDate.split('T')[0]} ~ ${item.endDate.split('T')[0]}</p>
                            
                            </div>
                        `;
                         $(containerId).append(festivalItem);

                });

            }
    
        }
        
        function noticeList(){
            
            $.ajax({
                url: "http://localhost:9002/khj/noticeList",
                type: 'GET',
                success: function(response){
                    
                    console.log(response);
                    const noticeTableBody = $('#notice-table tbody');
                    noticeTableBody.empty();
                    response.slice(0, 5).forEach(notice =>{
                        const maxLength = 50; // Í≥µÏßÄÏÇ¨Ìï≠ Ï†úÎ™© ÏûêÎ•º ÏµúÎåÄ Í∏∏Ïù¥ ÏÑ§Ï†ï
                        let truncatedTitle = notice.title;
                        if (truncatedTitle.length > maxLength) {
                            truncatedTitle = truncatedTitle.substring(0, maxLength) + '...';
                        }
                        
                        const noticeRow = `
                            <tr>
                                <td><a href="/notice/noticeDetail?hnum=${notice.hnum}">${truncatedTitle}</a></td>
                                <td>${notice.regDate}</td>                            
                            </tr>                    
                        `;
                        noticeTableBody.append(noticeRow);
                    });
                },
                error: function(xhr, status, error){
                    console.error("noticeList error : ", error);
                }
            });
        }
        
        noticeList();
        
        if (window.YT && YT.Player) {
            onYouTubeIframeAPIReady();
        } else {
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        $('#nextBtn').click(function() {
            if (currentIndex < videoIds.length - 1) {
                currentIndex++;
                loadVideo(currentIndex);
            }
        });

        $('#prevBtn').click(function() {
            if (currentIndex > 0) {
                currentIndex--;
                loadVideo(currentIndex);
            }
        });
        
        $.ajax({
            url: "http://localhost:9002/kibTest/photo",
            method: "GET",
            success: function(response){
                console.log("Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò¥.");
                
                response.forEach(function(photo){
                    var imgElement = $('<img>').attr('src', photo.main_img_thumb).addClass('photo-thumbnail');
                    var titleElement = $('<div>').text(photo.title).addClass('photo-title');
                    
                    var containerElement = $('<div>').addClass('photo-item');
                    containerElement.append(imgElement);
                    containerElement.append(titleElement);
                    
                    $('#photo-container').append(containerElement);
                });
            },
            error: function(xhr, status, error) { 
                console.error("Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.", error);
            }
        });
        
        var authValue = localStorage.getItem("Authorization");
        if (authValue != null) {
            $(".hiddenButton").css("display", "block");
        }
    });
</script>

</body>
</html>
