<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>온나부산 - 메인</title>
    <style>
        body {
            display: flex; /* 수직 방향으로 flex 레이아웃 설정 */
            flex-direction: column; /* 아이템들을 수직으로 배치 */
            min-height: 100vh; /* 최소 높이를 전체 화면 높이로 설정 */
            margin: 0; /* 기본 마진 제거 */
            padding: 0; /* 기본 패딩 제거 */
        }
        main {
            flex: 1; /* 남은 공간을 모두 차지하도록 설정 */
            padding: 20px 0; /* 상하 패딩 추가 */
            display: flex; /* 수직 방향으로 flex 레이아웃 설정 */
            flex-direction: column; /* 아이템들을 수직으로 배치 */
            align-items: center; /* 아이템들을 수평 가운데 정렬 */
        }
        .content-header {
            text-align: center; /* 텍스트를 가운데 정렬 */
            margin-bottom: 20px; /* 하단 마진 추가 */
        }
        #container {
            display: flex; /* 수평 방향으로 flex 레이아웃 설정 */
            flex-wrap: wrap; /* 아이템들을 여러 줄에 배치 */
            justify-content: center; /* 아이템들을 수평 가운데 정렬 */
            gap: 20px; /* 아이템들 사이의 간격 설정 */
            width: 90%; /* 컨테이너의 너비 설정 */
        }
        .tour-item {
           
            width: 25%; /* 아이템의 너비를 30%로 설정 */
            box-sizing: border-box; /* 패딩과 테두리를 포함한 너비 계산 */
            text-align: center; /* 텍스트를 가운데 정렬 */
            border: 1px solid #ccc; /* 테두리 추가 */
            padding: 10px; /* 아이템의 패딩 설정 */
            background-color: #f9f9f9; /* 아이템 배경색 설정 */
        }
        .tour-title {
            font-weight: bold; /* 폰트 굵게 설정 */
            margin: 10px 0; /* 상하 마진 설정 */
        }
        .tour-thumbnail {
            width: 100%; /* 이미지 너비를 100%로 설정 */
            height: auto; /* 이미지 높이를 자동으로 설정 */
            max-width: 250px; /* 이미지 최대 너비 설정 */
        }
        footer {
            background-color: #f1f1f1; /* 배경색 설정 */
            text-align: center; /* 텍스트를 가운데 정렬 */
            padding: 10px; /* 패딩 설정 */
            margin-top: 20px; /* 상단 마진 추가 */
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.js"
        integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
        crossorigin="anonymous"></script>
</head>
<body>

<header>
    <th:block th:insert="~{/fragments/aaa.html}"></th:block>
</header>

<main>
    <div class="content-header">
        <h1>온나부산에 오신 것을 환영합니다!</h1>
        <p>부산의 모든 것을 만나보세요.</p>
    </div>
    <div id="container"></div>
</main>

<footer>
    <th:block th:insert="~{/fragments/footer.html}"></th:block>
</footer>

<script>
    $(document).ready(function(){
        let tourData = [];

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("Geolocation은 이 브라우저에서 지원되지 않습니다.");
        }

        function showPosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            $.ajax({
                url: "http://localhost:9002/kibTest/tourList",
                type: 'GET',
                success: function(response) {
                    tourData = response;
                    tourData.forEach(item => {
                        item.distance = calculateDistance(lat, lon, item.latitude, item.longitude);
                    });
                    tourData.sort((a, b) => a.distance - b.distance);
                    const nearestTours = tourData.slice(0, 6);
                    renderTours(nearestTours);
                },
                error: function(xhr, status, error) {
                    console.error("Error: " + error);
                }
            });
        }

        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    alert("사용자가 위치 정보 제공을 거부했습니다.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("위치 정보를 사용할 수 없습니다.");
                    break;
                case error.TIMEOUT:
                    alert("위치 정보를 가져오는 시간이 초과되었습니다.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("알 수 없는 오류가 발생했습니다.");
                    break;
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 지구의 반경 (단위: km)
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c;
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        function renderTours(tours) {
            $('#container').empty();
            tours.forEach(item => {
                const tourItem = `
                    <div class="tour-item">
                        <div class="tour-title">${item.title}</div>
                        <a href="/tourDetail?uc_seq=${item.uc_seq}">
                            <img class="tour-thumbnail" src="${item.main_img_thumb}" alt="${item.title}">
                        </a>
                    </div>
                `;
                $('#container').append(tourItem);
            });
        }
    });
</script>

</body>
</html>
