<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부산 여행 AI 맞춤 일정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body.busan-travel-body {
            font-family: 'Noto Sans KR', sans-serif;
            margin-top: 80px;
            background-color: #f0f8ff;
        }
        .busan-travel-container {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        #busan-travel-map {
            height: 500px;
            width: 100%;
            margin-bottom: 30px;
            border: none;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .form-control, .form-select {
            border-radius: 10px;
        }
        .btn-primary {
            background-color: #005baa;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #004088;
        }
        .busan-travel-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .busan-travel-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        .busan-travel-table th, .busan-travel-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .busan-travel-table th {
            background-color: #005baa;
            color: white;
        }
        .gm-style-iw {
            padding: 15px;
            border-radius: 10px;
        }
        .gm-style-iw h3 {
            margin-top: 0;
            color: #005baa;
        }
        .gm-style-iw p {
            margin: 5px 0;
            color: #333;
        }
        @media (max-width: 768px) {
            .busan-travel-container {
                padding: 20px;
            }
            #busan-travel-map {
                height: 300px;
            }
        }
    </style>
</head>
<body class="busan-travel-body">
<header>
    <th:block th:insert="~{/fragments/header2.html}"></th:block>
</header>
    <div class="container mt-5 busan-travel-container">
        <h1 class="mb-4">부산 여행 AI 맞춤 일정</h1>
        <form id="planner-form">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="start-date" class="form-label">여행 시작 날짜:</label>
                    <input type="date" id="start-date" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label for="end-date" class="form-label">여행 종료 날짜:</label>
                    <input type="date" id="end-date" class="form-control" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="travel-type" class="form-label">여행 형태:</label>
                    <select id="travel-type" class="form-select">
                        <option value="activity">액티비티</option>
                        <option value="history">역사</option>
                        <option value="food">맛집</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="budget" class="form-label">예산 (원):</label>
                    <input type="number" id="budget" class="form-control" min="0" step="10000">
                </div>
                <div class="col-md-4">
                    <label for="transportation" class="form-label">교통 수단:</label>
                    <select id="transportation" class="form-select">
                        <option value="public">대중교통</option>
                        <option value="car">자동차</option>
                        <option value="walk">도보</option>
                    </select>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="busan-region" class="form-label">부산 지역:</label>
                    <select id="busan-region" class="form-select">
                        <option value="all">부산 전체</option>
                        <option value="중구">중구</option>
                        <option value="서구">서구</option>
                        <option value="동구">동구</option>
                        <option value="영도구">영도구</option>
                        <option value="부산진구">부산진구</option>
                        <option value="동래구">동래구</option>
                        <option value="남구">남구</option>
                        <option value="북구">북구</option>
                        <option value="해운대구">해운대구</option>
                        <option value="사하구">사하구</option>
                        <option value="금정구">금정구</option>
                        <option value="강서구">강서구</option>
                        <option value="연제구">연제구</option>
                        <option value="수영구">수영구</option>
                        <option value="사상구">사상구</option>
                        <option value="기장군">기장군</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">추천 여행 일정 생성</button>
        </form>

        <div class="busan-travel-loading" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">로딩중...</span>
            </div>
        </div>

        <div id="result" class="mt-4"></div>
        <div id="busan-travel-map" class="mt-4"></div>
    </div>
  <footer>
    <th:block th:insert="~{/fragments/footer.html}"></th:block>
  </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1VqsvOxs4dsglMk3wCxxB-_y58G3zyzU&callback=initMap" async defer></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"
        integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
        crossorigin="anonymous"></script>
    <script>
        let map;
        let markers = [];
        let polylines = [];
        let foodList = [];
        let tourList = [];

        function initMap() {
            const busan = { lat: 35.1796, lng: 129.0756 };
            map = new google.maps.Map(document.getElementById('busan-travel-map'), {
                center: busan,
                zoom: 12
            });
            loadFoodData();
            loadTourData();
        }

        function loadFoodData() {
            $.ajax({
                url: "http://localhost:9002/kibTest/food",
                method: "GET",
                success: function(response) {
                    console.log("Food data loaded:", response);
                    foodList = response;
                },
                error: function(error) {
                    console.error('Error fetching food data:', error);
                }
            });
        }

        function loadTourData() {
            $.ajax({
                url: "http://localhost:9002/kibTest/tourList",
                type: 'GET',
                success: function(response) {
                    console.log("Tour data loaded:", response);
                    tourList = response;
                },
                error: function(error) {
                    console.error('Error fetching tour data:', error);
                }
            });
        }

        function getFormattedDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function setMinDate() {
            const today = new Date();
            const formattedDate = getFormattedDate(today);
            document.getElementById('start-date').setAttribute('min', formattedDate);
            document.getElementById('end-date').setAttribute('min', formattedDate);
        }

        function setEndDateMin() {
            const startDate = document.getElementById('start-date').value;
            document.getElementById('end-date').setAttribute('min', startDate);
        }

        async function fetchWeatherData(startDate, endDate) {
            const cityName = 'Busan';
            const url = `/proxy/weather-api?q=${cityName}&units=metric`;
            const response = await fetch(url);
            const data = await response.json();
            return data.list.filter(item => {
                const itemDate = new Date(item.dt * 1000);
                return itemDate >= startDate && itemDate <= endDate;
            }).map(item => ({
                date: new Date(item.dt * 1000).toISOString().split('T')[0],
                weather: item.weather[0].description,
                temp: item.main.temp
            }));
        }

        async function fetchOpenAI(prompt) {
            const apiKey = '';
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [{"role": "user", "content": prompt}]
                })
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data.choices[0].message.content.trim();
        }

        function displayAIResponse(response) {
            const resultDiv = document.getElementById('result');
            const days = parseItinerary(response);
            let tableHtml = '<table class="busan-travel-table">';
            tableHtml += '<tr><th>날짜</th><th>시간</th><th>장소</th><th>활동</th><th>비용</th><th>날씨</th></tr>';
            
            for (const date in days) {
                days[date].forEach((item, index) => {
                    tableHtml += `<tr>
                        ${index === 0 ? `<td rowspan="${days[date].length}">${date}</td>` : ''}
                        <td>${item.time}</td>
                        <td>${item.name}</td>
                        <td>${item.activity}</td>
                        <td>${item.cost}</td>
                        <td>${item.weather}</td>
                    </tr>`;
                });
            }
            tableHtml += '</table>';
            resultDiv.innerHTML = tableHtml;
        }

        function parseItinerary(itinerary) {
            const lines = itinerary.split('\n');
            const days = {};
            let currentDate = '';

            lines.forEach(line => {
                const dateMatch = line.match(/^(\d{4}-\d{2}-\d{2}):/);
                if (dateMatch) {
                    currentDate = dateMatch[1];
                    if (!days[currentDate]) {
                        days[currentDate] = [];
                    }
                } else {
                    const match = line.match(/(\d{2}:\d{2}): (.+) \((\d+\.\d+),\s*(\d+\.\d+)\) \| (.+) \| (.+) \| (.+)/);
                    if (match && currentDate) {
                        const [_, time, name, lat, lng, activity, cost, weather] = match;
                        days[currentDate].push({
                            time: time,
                            name: name,
                            lat: parseFloat(lat),
                            lng: parseFloat(lng),
                            activity: activity,
                            cost: cost,
                            weather: weather
                        });
                    }
                }
            });

            return days;
        }

        function getColor(index) {
            const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF'];
            return colors[index % colors.length];
        }

        function drawMarkersAndPolylines(days) {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            polylines.forEach(polyline => polyline.setMap(null));
            polylines = [];

            let dayIndex = 0;
            const bounds = new google.maps.LatLngBounds();

            for (const date in days) {
                const color = getColor(dayIndex);
                const places = days[date];

                const path = places.map((place, index) => {
                    const latLng = new google.maps.LatLng(place.lat, place.lng);
                    bounds.extend(latLng);

                    const marker = new google.maps.Marker({
                        position: latLng,
                        map: map,
                        title: place.name,
                        animation: google.maps.Animation.DROP,
                        label: {
                            text: (index + 1).toString(),
                            color: 'white'
                        },
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10,
                            fillColor: color,
                            fillOpacity: 1,
                            strokeColor: 'white',
                            strokeWeight: 2
                        }
                    });

                    const infowindow = new google.maps.InfoWindow({
                        content: `<div>
                            <h3>${place.name}</h3>
                            <p>시간: ${place.time}</p>
                            <p>활동: ${place.activity}</p>
                            <p>비용: ${place.cost}</p>
                            <p>날씨: ${place.weather}</p>
                        </div>`
                    });

                    marker.addListener('click', () => {
                        infowindow.open(map, marker);
                    });

                    markers.push(marker);

                    return latLng;
                });

                const polyline = new google.maps.Polyline({
                    path: path,
                    geodesic: true,
                    strokeColor: color,
                    strokeOpacity: 1.0,
                    strokeWeight: 2
                });
                polyline.setMap(map);
                polylines.push(polyline);

                dayIndex++;
            }

            map.fitBounds(bounds);
            
            google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
                if (this.getZoom() > 12) {
                    this.setZoom(12);
                }
            });
        }

        document.getElementById('planner-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const loadingDiv = document.querySelector('.busan-travel-loading');
            loadingDiv.style.display = 'flex';

            const startDate = new Date(document.getElementById('start-date').value);
            const endDate = new Date(document.getElementById('end-date').value);
            const travelType = document.getElementById('travel-type').value;
            const budget = document.getElementById('budget').value;
            const transportation = document.getElementById('transportation').value;
            const selectedRegion = document.getElementById('busan-region').value;

            try {
                const weatherData = await fetchWeatherData(startDate, endDate);
                const weatherSummary = weatherData.map(item => 
                    `Date: ${item.date}, Weather: ${item.weather}, Temperature: ${item.temp}°C`
                ).join('\n');

                const filteredFoodList = selectedRegion === 'all' ? foodList : foodList.filter(item => item.gugun_nm === selectedRegion);
                const filteredTourList = selectedRegion === 'all' ? tourList : tourList.filter(item => item.gugun_nm === selectedRegion);

                const prompt = `다음은 부산 여행 일정 계획에 필요한 정보입니다.
                - 여행 시작 날짜: ${getFormattedDate(startDate)}
                - 여행 종료 날짜: ${getFormattedDate(endDate)}
                - 여행 형태: ${travelType}
                - 예산: ${budget}원
                - 교통 수단: ${transportation}
                - 선택한 지역: ${selectedRegion}
                - 날씨 요약: ${weatherSummary}

                추천 가능한 음식점 목록:
                ${filteredFoodList.map(item => `${item.main_title} (${item.lat}, ${item.lng})`).join('\n')}

                추천 가능한 관광지 목록:
                ${filteredTourList.map(item => `${item.place} (${item.lat}, ${item.lng})`).join('\n')}

                위 정보를 바탕으로 매일 추천 시간과 일정을 만들어 주세요. 
                하루에 최소 3곳의 장소를 방문하고  반드시 식사시간에 근처 맛집도 추천합니다.
                추천 관광코스를 생성할 때는 근처에 있는 곳을 먼저 추천해서 효율적인 여행이 될 수 있도록 한다
                각 장소에 대해 사용자가 입력한 각 날짜 별로 다음 형식으로 응답해주세요:
                YYYY-MM-DD:
                시간: <장소명> (위도, 경도) | 활동 설명 | 예상 비용 | 날씨
                예: 
                2024-07-20:
                10:00: 부산타워 (35.1796, 129.0756) | 전망대 관람 | 10,000원 | 맑음`;

                const itinerary = await fetchOpenAI(prompt);
                displayAIResponse(itinerary);
                const days = parseItinerary(itinerary);
                if (Object.keys(days).length > 0) {
                    drawMarkersAndPolylines(days);
                } else {
                    console.error("No valid places found in the itinerary.");
                }

            } catch (error) {
                document.getElementById('result').innerHTML = `<div class="alert alert-danger">오류가 발생했습니다: ${error.message}</div>`;
            } finally {
                loadingDiv.style.display = 'none';
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            setMinDate();
            document.getElementById('start-date').addEventListener('change', setEndDateMin);
        });
    </script>
</body>
</html>