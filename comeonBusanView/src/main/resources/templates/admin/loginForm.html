<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!--@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap');-->

<head>
<meta charset="UTF-8">
<title>로그인</title>
<style>
* {
	margin: 0;
	padding: 0;
}

body {
	font-family: 'Noto Sans KR', sans-serif;
}

.container {
	display: flex;
	justify-content: center;
	align-items: center;
	height: 100vh;
	background-color: #f5f5f5;
}

.login-form {
	width: 100%;
	max-width: 400px;
	background: white;
	padding: 40px;
	box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
	border-radius: 10px;
	text-align: center;
}

.login-form h1 {
	margin-bottom: 50px;
	font-size: 32px;
}

.int-area {
	position: relative;
	margin-top: 20px;
}

.int-area:first-child {
	margin-top: 0;
}

.int-area input {
	width: 100%;
	padding: 20px 10px 10px;
	background-color: transparent;
	border: none;
	border-bottom: 1px solid black;
	font-size: 18px;
	outline: none;
}

.int-area label {
	position: absolute;
	left: 10px;
	top: 15px;
	font-size: 18px;
	transition: top 0.5s ease;
}

.int-area label.warning {
	color: red !important;
	animation: warning 0.3s ease;
	animation-iteration-count: 3;
}

		@keyframes warning {
			0% {
				transform: translateX(-8px);
			}

			25% {
				transform: translateX(8px);
			}

			50% {
				transform: translateX(-8px);
			}

			75% {
				transform: translateX(8px);
			}
		}
.int-area input:focus+label, .int-area input:valid+label {
	top: -2px;
	font-size: 13px;
	color: #166caa;
}

.btn-area {
	margin-top: 30px;
}

.btn-area button, .btn-area input[type="submit"] {
	width: 100%;
	height: 50px;
	margin: 0px 10px;
	color: #fff;
	background: #166caa;
	border: none;
	border-radius: 20px;
	font-size: 20px;
	cursor: pointer;
}

.caption {
	margin-top: 20px;
	text-align: center;
}

.caption a {
	margin: 0 20px;
	font-size: 15px;
	color: blue;
	text-decoration: none;
}

    /* 모달 스타일 추가 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 10px;
            text-align: center;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            font-size: 16px;
        }

        .modal-content input,
        .modal-content button {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .modal-content button {
            background-color: #166caa;
            color: white;
            border: none;
            cursor: pointer;
        }

        .modal-content button:hover {
            background-color: #135a8d;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
</style>
<script src="https://code.jquery.com/jquery-3.7.1.js"
	integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
	crossorigin="anonymous"></script>
<script>	
	function submitForm(event) {
		event.preventDefault(); // 기본 폼 전송을 막기 위해 필요합니다.

		var form = document.forms['frm'];
		var formData = $(form).serialize();

		$.ajax({
			type : "POST",
			url : "http://localhost:9002/login",
			contentType : 'application/x-www-form-urlencoded',
			data : formData,
			success : function(data, status, xhr) {
				console.log("success : ", data);
				var headers = xhr.getAllResponseHeaders();
				console.log(headers);
				alert("로그인 되었습니다.");
				var token = xhr.getResponseHeader("Authorization");
				if (token != null) {
					console.log("JWT Token: " + token.split(" ")[1]);
					localStorage.setItem("Authorization", token.split(" ")[1]);
					window.location.href = "/adminPage"; // 로그인 성공 시 이동할 페이지
				} else {
					console.log("Authorization 헤더가 없습니다.");
				}
			},
			error : function(error) {
				console.log("error 발생");
			}
		});
	}

	function requestAdmin() {
		const token = localStorage.getItem("Authorization");
		console.log(token);
		$.ajax({
			type : "GET",
			url : "http://localhost:9002/admin",
			headers : {
				"Authorization" : "Bearer " + token // Bearer 토큰 형식을 사용하여 토큰을 포함
			},
			success : function(data) {
				console.log("Success:", data);
				// 사용자 프로필 등을 처리
				document.getElementById("demo2").innerHTML = data;
			},
			error : function() {
				console.log("Error가 났어요");
				// 인증 실패 등의 오류 처리
			}
		});
	}
</script>
</head>



<body>
	<header>
		<th:block th:insert="~{/fragments/header2.html}"></th:block>
	</header>
	<div class="container">
		<section class="login-form">
			<h1>로그인</h1>
			<form name="frm" onsubmit="submitForm(event)">
				<div class="int-area">
					<input type="text" name="username" placeholder="username" /> <label
						for="username">ID</label>
				</div>
				<div class="int-area">
					<input type="password" name="password" placeholder="password" /> <label
						for="password">PASSWORD</label>
				</div>
				<div class="btn-area">
					<input type="submit" id="btn" value="LOGIN" />
				</div>
			</form>
			<div class="caption">
				<a href="#" id="forgotPasswordLink">Forgot Password?</a> <a
					href="/joinForm">회원가입</a>
			</div>
		</section>
		<!--<button onclick="requestAdmin()">Admin Page 요청하기</button>
<div id="demo2"></div>
-->
	</div>

 <!-- 첫 번째 모달: ID 입력 -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>새 비밀번호 세팅을 위해 아이디를 입력해주세요</h3>
            <form id="idForm">
                <input type="text" id="username" name="username" placeholder="username" required />
                <button type="submit">다음</button>
            </form>
        </div>
    </div>

    <!-- 두 번째 모달: 이메일 입력 -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>비밀번호 설정 링크를 받으실 이메일을 입력해주세요</h3>
            <form id="emailForm">
                <input type="email" id="email" name="email" placeholder="Enter your email" required />
                <button type="submit">전송</button>
            </form>
        </div>
    </div>

	<footer>
		<th:block th:insert="~{/fragments/footer.html}"></th:block>
	</footer>


 	<script>
 	 // 모달 제어 변수
     var modal = document.getElementById("myModal");
     var emailModal = document.getElementById("emailModal");
     var btn = document.getElementById("forgotPasswordLink");
     var closeButtons = document.getElementsByClassName("close");
     var username = ""; // username을 저장할 변수

     // 모달 열기
     btn.onclick = function(event) {
         event.preventDefault();
         modal.style.display = "block";
     }

     // 모달 닫기
     for (var i = 0; i < closeButtons.length; i++) {
         closeButtons[i].onclick = function() {
             modal.style.display = "none";
             emailModal.style.display = "none";
         }
     }

     window.onclick = function(event) {
         if (event.target == modal || event.target == emailModal) {
             modal.style.display = "none";
             emailModal.style.display = "none";
         }
     }

     // 첫 번째 모달 폼 제출 처리
     document.getElementById('idForm').addEventListener('submit', function(event) {
         event.preventDefault();

         username = document.getElementById('username').value;

         const userData = { username: username };

         console.log(userData);

         $.ajax({
             type: 'POST',
             url: 'http://localhost:9002/findAdminId',
             data: JSON.stringify(userData), // JSON 문자열로 직접 전송
             contentType: 'application/json', // contentType 설정
             success: function(response) {
                 console.log(response);
                 if (response == username) {
                     // 첫 번째 모달 닫고 두 번째 모달 열기
                     modal.style.display = "none";
                     emailModal.style.display = "block";
                 } else {
                     alert(response);
                 }
             },
             error: function(e) {
                 console.log("error : ", e);
                 alert('An error occurred while processing your request.');
             }
         });
     });

     // 두 번째 모달 폼 제출 처리
     document.getElementById('emailForm').addEventListener('submit', function(event) {
         event.preventDefault();

         let email = document.getElementById('email').value;
         const userData = { email: email, username: username };

         console.log(userData);

         $.ajax({
             type: 'POST',
             url: 'http://localhost:9002/send-reset-password',
             data: JSON.stringify(userData),
             contentType: 'application/json',
             success: function(response) {
                 console.log(response.uuid);
                 alert('메일이 전송되었습니다. 이메일 속 링크를 확인해주세요');
                 emailModal.style.display = "none";
             },
             error: function(xhr, status, error) {
                 console.error("Error: " + error);
                 if (xhr.status === 400) {
                     alert('회원가입 시 입력한 이메일을 입력해 주세요.');
                 } else {
                     alert('Failed to send reset password email.');
                 }
             }
         });
     });
    
	
</script> 
</body>

</html>