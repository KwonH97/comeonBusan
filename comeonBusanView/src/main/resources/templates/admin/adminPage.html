<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>관리자 대시보드</title>
<style>
body {
	font-family: Arial, sans-serif;
	margin: 0;
	padding: 0;
}

.content {
	display: flex;
	justify-content: space-between;
	padding: 120px 20px; /*상하 와 좌우*/
	margin: 0 auto;
	max-width: 1200px;
}

.canvas-content {
	flex: 1; /* 차트 영역이 기본적으로 공간을 차지 */
	max-width: 50%;
	margin-right: 20px;
}

table {
	width: 100%;
	border-collapse: collapse;
}

table, th, td {
	border: 1px solid #ddd;
}

th, td {
	padding: 8px;
	text-align: left;
}

th {
	background-color: #f4f4f4;
}

/* 작은 화면에서 레이아웃 조정 */
@media ( max-width : 768px) {
	.content {
		flex-direction: column;
		align-items: center;
	}
	.canvas-content, table {
		max-width: 100%;
		margin-right: 0;
	}
}

/* 노멀라이즈 시작 */
ul, li {
	margin: 0;
	padding: 0;
	list-style: none;
}

a {
	color: inherit; /* 부모 엘리먼트의 값을 물려받는다 */
	text-decoration: none;
}

/* 노멀라이즈 끝 */

/* 2차 이상의 메뉴를 숨기기*/
.side-bar>ul ul {
	display: none;
}

/* 사이드바의 너비와 높이를 변수를 통해 통제 */
:root {
	--side-bar-width: 270px;
	--side-bar-height: 90vh;
}

.side-bar {
	position: fixed;
	background-color: #164772;
	width: var(--side-bar-width);
	min-height: var(--side-bar-height);
	margin-top: calc(( 100vh - var(--side-bar-height))/2);
	/* 헤더 영역 위에 고정되도록 수정 */
	top: 0; /* 헤더 영역 위에 붙이기 */
	z-index: 1000; /* 다른 요소들 위에 나타나도록 z-index 설정 */
}

/* 모든 메뉴의 a에 속성값 부여 */
.side-bar ul>li>a {
	display: block;
	color: white;
	font-size: 1.4rem;
	font-weight: bold;
	padding-top: 20px;
	padding-bottom: 20px;
	padding-left: 50px;
}

/* 자식의 position이 absolute일 때 자식을 영역 안에 가두어 준다 */
.side-bar>ul>li {
	position: relative;
}

/* 모든 메뉴가 마우스 인식 시 반응 */
.side-bar ul>li:hover>a {
	background-color: #4178A5;
	border-bottom: 1px solid #999;
}

/* 1차 메뉴의 항목이 마우스 인식 시에 2차 메뉴 등장 */
.side-bar>ul>li:hover>ul {
	display: block;
	position: absolute;
	background-color: #888;
	top: 0; /* 2차 메뉴의 상단을 1차 메뉴의 상단에 고정 */
	left: 100%; /* 2차 메뉴를 1차 메뉴의 너비만큼 이동 */
	width: 100%; /* 1차 메뉴의 너비를 상속 */
}

/* 사이드바 너비의 80%만큼 왼쪽으로 이동 */
.side-bar {
	border-radius: 20px;
	transform: translate(calc(var(--side-bar-width)* -0.8), 0);
	/* X축 이동, Y축 고정 */
	transition: .5s;
}

/* 마우스 인식 시 원래의 위치로 이동 */
.side-bar:hover {
	transform: translate(-20px, 0); /* 둥근 모서리의 너비만큼 X축 이동, Y축 고정 */
}

/* 에러 메시지 스타일링 */
.error-message {
	color: black;
	text-align: center;
	padding: 20px;
	font-size: 1.2rem;
	
}

#inquiryContents {

 width: 350px;

}
</style>
<script src="https://code.jquery.com/jquery-3.7.1.js"
	integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
	crossorigin="anonymous"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
</head>
<body>
	<header>
		<th:block th:insert="~{/fragments/header2.html}"></th:block>
	</header>
	<aside class="side-bar">
		<section class="side-bar__icon-box">
			<section class="side-bar__icon-1">
				<div></div>
				<div></div>
				<div></div>
			</section>
		</section>
		<ul>
			<li><a href="#"><i class="fa-solid fa-cat"></i> 게시물 등록</a>
				<ul>
					<li><a href="/regi_tour">관광명소 등록</a></li>
					<li><a href="/regLodgment">숙박업소 등록</a></li>
					<li><a href="/regi_food">맛집 등록</a></li>
					<li><a href="/festivalAdd">축제/행사 등록</a></li>
				</ul></li>
			<li><a href="/notice/noticeList">공지사항 관리</a></li>
			<li><a href="/newsLetter">뉴스레터 관리</a></li>
			<li><a href="/dangerArea">위험지역 관리</a></li>
			<li><a href="/inquiryList">문의사항 관리</a></li>
			<li><a href="#" id="logout-link">로그아웃</a></li>
		</ul>
	</aside>

	<div class="content">
		<div class="canvas-content">
			<canvas id="bar-chart" width="300" height="230"></canvas>
		</div>

		<div class="table-content">
		<h3>미답변 문의사항</h3>
			<table border="1">
				<thead>
					<tr>
						<th id="inquiryContents">문의내용</th>
						<th>등록일</th>
					</tr>
				</thead>
				<tbody>

				</tbody>
			</table>

		</div>

	</div>
	<!--         <h1>Admin Page</h1>
        <p>관리자 페이지에 오신 것을 환영합니다!</p>

        <div style="margin-top: 20px;">
            <a href="/dangerArea" class="admin-button">위험지역 관리</a>
        </div>
        <div style="margin-top: 20px;">
            <a href="/newsLetter" class="admin-button">뉴스레터 관리</a>
        </div>
        <div style="margin-top: 20px;">
            <a href="/notice/noticeList" class="admin-button">공지사항 관리</a>
        </div>
        <div style="margin-top: 20px;">
            <button class="logout-button" onclick="logout()">로그아웃</button>
        </div>
-->

	<footer>
		<th:block th:insert="~{/fragments/footer.html}"></th:block>
	</footer>

	<script>
	
		// 로그아웃 함수
		function logout() {
			localStorage.removeItem("Authorization");
			window.location.href = "/main";
		}
		
		// 차트에 필요한 데이터 가지고 오는 함수
		function chartData(){
			
			console.log("chartData 실행되었다.......");
			
			$.ajax({
				
				url: "http://localhost:9002/chart/getChartData",
				type:  "GET",
				success: function(response){
					
					console.log(response);
					processChartData(response);
					
				},
				error: function(e){
					
					console.error(e);
					// 화면에서 조회수 없을을 알려주도록 처리
					displayError("조회수 데이터가 조회되지 않습니다.");
					
				}
			});
			
		}
		
		// 에러 메시지를 테이블에 표시하는 함수
		function displayError(message){
			
			const place = document.querySelector('.canvas-content'); 
			place.innerHTML = `<p class="error-message">${message}</p>`;
			
		}

		//데이터를 처리하여 차트를 업데이트하는 함수
			function processChartData(data) {
			    // 데이터를 날짜별로 그룹화하여 조회수 합산
			    let aggregatedData = {};
			
			    data.forEach(item => {
			        let date = item[0]; // 첫 번째 요소는 날짜
			        let count = parseInt(item[1]); // 두 번째 요소는 조회수
			
			        if (aggregatedData[date]) {
			            aggregatedData[date] += count;
			        } else {
			            aggregatedData[date] = count;
			        }
			    });
			
			    // 오늘 날짜와 7일 전 날짜를 계산
			    let today = new Date();
			    let pastWeek = new Date();
			    pastWeek.setDate(today.getDate() - 6); // 7일간의 범위 (오늘 포함)
			
			    // 날짜를 오늘 기준으로 7일 이내로 필터링
			    let filteredData = {};
			    for (let date in aggregatedData) {
			        let dataDate = new Date(date);
			        if (dataDate >= pastWeek && dataDate <= today) {
			            filteredData[date] = aggregatedData[date];
			        }
			    }
			
			    // 날짜를 오래된 순서로 정렬하기
			    let sortedDates = [];
			    for (let i = 0; i <= 6; i++) {
			        let date = new Date(pastWeek);
			        date.setDate(date.getDate() + i);
			        let formattedDate = formatDate(date);
			        if (!filteredData[formattedDate]) {
			            filteredData[formattedDate] = 0; // 데이터가 없으면 0으로 설정
			        }
			        sortedDates.push(formattedDate);
			    }
			
			    let viewCounts = sortedDates.map(date => filteredData[date] || 0);
			
			    // 차트에 사용할 라벨과 데이터 배열 생성
			    let labels = sortedDates;
			
			    // 차트를 업데이트하는 함수 호출
			    updateChart(labels, viewCounts);
			}
			
			// 날짜를 "yyyy-MM-dd" 형식으로 포맷하는 함수
			function formatDate(date) {
			    let year = date.getFullYear();
			    let month = (date.getMonth() + 1).toString().padStart(2, '0'); // 월은 0부터 시작하므로 +1
			    let day = date.getDate().toString().padStart(2, '0');
			    return `${year}-${month}-${day}`;
			}
		
		// 차트를 업데이트하는 함수 
		
		function updateChart(labels, data){
			 new Chart(document.getElementById("bar-chart"), {
			        type: 'bar',
			        data: {
			            labels: labels,
			            datasets: [{
			                label: "방문자 수 (명) ",
			                backgroundColor: ["#3e95cd", "#8e5ea2", "#3cba9f", "#e8c3b9", "#c45850", "#90acd0", "#fbacc8"],
			                data: data
			            }]
			        },
			        options: {
			            scales: {
			                x: {
			                    ticks: {
			                        autoSkip: true, // x축 레이블을 자동으로 건너뛰기 (레이블 겹침 방지)
			                        maxRotation: 90, // x축 레이블의 최대 회전 각도
			                        minRotation: 45 // x축 레이블의 최소 회전 각도
			                    }
			                },
						
						
						  yAxes: [{ // chart.js 버전이 2.x일때는 yAxes를 사용해서 y축읙 값을 설정해준다.
			                    ticks: {
			                        beginAtZero: true, // y축의 시작점을 0으로 설정
			                        min: 0 // y축의 최소값을 0으로 설정
			                    }
			                }]
					},
					
					legend: {
						display: false
					},
					title: {
						display: true,
						text: '온나 부산 주간 방문자 수',
						fontSize: 24,
						fontFamily: 'Arial', // 타이틀 글꼴 패밀리
			            fontStyle: 'bold', // 타이틀 글꼴 스타일
			            fontColor: '#333' // 타이틀 글꼴 색상
					
			        }
				}
				
			});
		
		}
		
		//DOM이 로드된 후에 이벤트 리스너 추가
		document.addEventListener("DOMContentLoaded", function() {
			document.getElementById("logout-link").addEventListener("click",
					function(event) {

						event.preventDefault(); // 기본 링크 동작 막음
						logout();

					});
			
			// 페이지가 로드될때 차트 데이터를 가지고 오는 함수 실행
			chartData();
			// 페이지가 로드될때 문의사항 데이터를 가지고 오는 함수 실행
			getInquiryData();
			
		});
		
		function getInquiryData(){
			
			console.log("getInquiryData 실행되었다.......");
			
			$.ajax({
				
				url: "http://localhost:9002/getInquiryInfo",
				type:  "GET",
				success: function(response){
					
					console.log(response);
					makeInquiryTable(response); // 문의사항 테이블 만드는 함수
					
				},
				error: function(e){
					
					console.error(e);
				}
			});
			
			
			
		}
		
		// 문의사항 테이블 만드는 함수
		function makeInquiryTable(data){
			
			console.log("data in makeinTable" + data);
			
			const tableBody = document.querySelector('.table-content tbody');
			tableBody.innerHTML = ''; // 기존 내용 초기화
			
			// data가 배열인지 객체인지 확인
			
			if(Array.isArray(data)){
				data.forEach(item => {
					let row = `<tr><td>${item.inquiry}</td><td>${item.regDate}</td></tr>`;
					tableBody.insertAdjacentHTML('beforeend', row);
				});
			} else {
				
				//객체인 경우 (단일 객체)
				let row = `<tr><td>${data.inquiry}</td><td>${data.regDate}</td></tr>`;
				tableBody.innerHTML = row;
			}
			
		}
		
		
// 		// 차트 생성 코드
// 		new Chart(document.getElementById("bar-chart"), {
// 			type : 'bar',
// 			data : {
// 				labels : [ "Africa", "Asia", "Europe", "Latin America",
// 						"07/24", "Yesterday", "Today" ],

// 				datasets : [ {
// 					label : "방문자 수 (명) ",
// 					backgroundColor : [ "#3e95cd", "#8e5ea2", "#3cba9f",
// 							"#e8c3b9", "#c45850", "red", "blue" ],

// 					data : [ 1, 20, 30, 24, 11, 11, 13 ]
// 				} ]
// 			},
// 			options : {
// 				legend : {
// 					display : false
// 				},
// 				title : {
// 					display : true,
// 					text : '온나 부산 주간 방문자 수'
// 				}
// 			}
// 		});
		

	</script>
</body>
</html>
