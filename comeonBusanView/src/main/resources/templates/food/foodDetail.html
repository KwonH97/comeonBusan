<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>맛집 상세페이지</title>
<script src="https://code.jquery.com/jquery-3.7.1.js"
	integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
	crossorigin="anonymous"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1VqsvOxs4dsglMk3wCxxB-_y58G3zyzU"></script> <!-- Google Maps API 스크립트 추가 -->
<style>
  #map {
    height: 500px; /* 원하는 높이로 설정 */
    width: 100%; /* 원하는 너비로 설정 */
    margin: 20px 0; /* 위아래 여백 설정 */
  }
  
  	.heart-button {
	background-color: transparent;
	border: none;
	cursor: pointer;
	outline: none;
	padding: 0;
	width: 50px;
	height: 50px;
}

.heart-icon {
	fill: transparent;
	stroke: black;
	stroke-width: 1; /*테두리 더 굴게 얇게 조정*/
	transition: transform 0.2s;
}

.heart-button:hover .heart-icon {
	transform: scale(1.1);
}

.heart-icon.liked {
	fill: red;
	stroke: red;
}

	.button-container {
		display: flex;
		gap: 10px;
		margin-top: 20px; 
	}
	
	.hiddenButton {
		background-color: #e71b85;
		color: white; /* 버튼 색상에 잘 보이는 흰색 텍스트 */
	    border: none;
	    border-radius: 12px; /* 둥근 모서리 */
	    padding: 8px 16px; /* 버튼 내 여백 (기본 크기보다 20% 작게) */
	    font-size: 14px; /* 텍스트 크기 (기본 크기보다 20% 작게) */
	    font-weight: bold; /* 텍스트 굵기 */
	    cursor: pointer; /* 마우스를 올렸을 때 포인터 아이콘 */
	    transition: background-color 0.3s ease, color 0.3s ease; /* 부드러운 색상 변화 */
	    text-align: center; /* 텍스트 가운데 정렬 */
	}
	
	.hiddenButton:hover {
		background-color: #c2185b;
		color: white;
	}

	.container {
		width: 80%;
		max-width: 1200px;
		margin: 0 auto;
		padding: 20px;
		box-sizing: border-box;
		background-color: #fff;
		border-radius: 8px;
		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
	}
	
	#main_title{
		font-size: 36px;
		font-weight: bold;
		color: black;
		text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
		margin-bottom: 20px;
		padding: 10px;
		border-radius: 5px;
		text-align: center;
	}
	
	#subtitle{
		text-align: center;
	}
	
	#main_img_normal {
		display: block;
		margin: 0 auto;
		width: 100%;
		height: auto;
		max-width: 100%;
	}
	
	.interaction-container {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 20px;
	}
	
	.left-section {
		display: flex;
		align-items: center;
		gap: 10px;
	}
	
	.view-count {
		margin-right: 20px;
	}
	
	.like-section {
		display: flex;
		align-items: center;
		gap: 10px;
		border-left: 1px solid rgba(0, 0, 0, 0.2);
		padding-left: 20px;
	}
	
	.heart-text{
		font-size: 16px;
		color: #e71b85;
	}
	
	.right-section {
		display: flex;
		align-items: center;
	}
	
	.right-section button {
		padding: 10px 20px;
		background-color: #e71b85;
		color: white;
		border: none;
		border-radius: 5px;
		cursor: pointer;
		font-size: 16px;
	}
	
	.right-section button:hover {
		background-color: #d4186b;
	}
	
	.info {
		font-weight: bold;
		font-size: 20px;
	}
	
	#placeInfo {
		border: 4px solid gray;
		padding: 10px;
		margin: 20px 0;
		display: flex;
		flex-wrap: wrap;
		gap: 10px;
		border-radius: 8px;
	}
	
	.info-group{
		flex: 1;
		padding: 10px;
		position: relative;
	}
	
	.info-group:not(last-child)::after {
		content: "";
		position: absolute;
		top: 0;
		right: 0;
		height: 100%;
		width: 1px;
		background-color: rgba(0, 0, 0, 0.2);
		border-radius: 2px;
	}
	.info-group span{
		display: block;
		margin-bottom: 5px;
	}
	
	#itemcntnts {
		white-space: pre-wrap;
	}
	
	
</style>
</head>
<body>
<header>
        <th:block th:insert="~{/fragments/header2.html}"></th:block>
</header>

<div class="button-container">
	<button class="hiddenButton" onclick="modifyFoodTour()" style="display: none;">수정하기</button>
	<button class="hiddenButton" onclick="deletethisPage()" style="display: none;">삭제하기</button>
</div>

<div class="container">
	<h3 id="main_title"></h3>
	<h4 id="subtitle"></h4>
	
	<img id="main_img_normal" alt="맛집 홍보사진"><br>
	
	<div class="interaction-container">
		<div class="left-section">
			<span>조회수 : <span id="viewcount"></span></span>
			<div class="like-section">
				<button class="heart-button" onclick="doLike()">
				<svg class="heart-icon" viewBox="0 0 24 24" width="50" height="50">
						<path
							d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
					</svg>
				</button>
				<span>( </span><span id="likecount"></span><span> )</span><br>
			</div>
		</div>
		<div class="right-section">
			<button onclick="loadBlogPage(uc_seq)">리뷰보기</button><br>
		</div>
	</div>
	
	<span class="info">대표메뉴</span><span id="rprsntv_menu"></span>  
	<h4 id="rprsntv_menu"></h4>
	<div id="itemcntnts"></div>
	
	<div id="placeInfo">
		
		<div class="info-group">
			<span class="info">주소 </span><span id="addr1"></span>
			<span class="info">운영 및 시간 </span><span id="usage_day_week_and_time"></span>
		</div>
		
		<div class="info-group">
			<span class="info">연락처 </span><span id="cntct_tel"></span>
			<span class="info">홈페이지 </span><a href="" id="link"><span id="homepage_url"></span></a>
		</div>
		
	</div>
	
	<div id="map"></div> <!-- 지도를 표시할 div 추가 -->
</div>
  <footer>
    <th:block th:insert="~{/fragments/footer.html}"></th:block>
  </footer>
<script>
	var uc_seq = "[[${uc_seq}]]";
	
	function loadBlogPage(uc_seq) {
        window.location.href = `/blog?type=food&uc_seq=${uc_seq}`;
    }
	
	$(document).ready(function(){
		
		/*
		// 조회수 증가 요청 보내기
		$.ajax({
			url: 'http://localhost:9002/views/food/' + uc_seq,
			method: 'POST',
			success: function() {
				console.log("View count incremented");
			},
			error: function(error) {
				console.error("Error incrementing view count: " + error);
			}
		});

		// 조회수 가져오기
		$.ajax({
			url: 'http://localhost:9002/views/food/' + uc_seq,
			method: 'GET',
			success: function(viewCount) {
				console.log("Current view count: " + viewCount);
				document.querySelector("#viewcount").textContent = viewCount;
			},
			error: function(error) {
				console.error("Error fetching view count: " + error);
			}
		});
		*/
		
		$.ajax({
			url:"http://localhost:9002/kibTest/food/" + uc_seq,
			method: "GET",
			success: function(response){
				console.log("데이터 확인: ");
				
				document.querySelector("h3#main_title").textContent = response.main_title;
				document.querySelector("h4#subtitle").textContent = response.subtitle;
				document.querySelector("img#main_img_normal").src = response.main_img_normal;
				
				document.querySelector("h4#rprsntv_menu").textContent = response.rprsntv_menu;
				document.querySelector("div#itemcntnts").innerHTML = response.itemcntnts;
				
				document.querySelector("span#addr1").textContent = response.addr1;
				document.querySelector("span#usage_day_week_and_time").textContent = response.usage_day_week_and_time;
				document.querySelector("span#cntct_tel").textContent = response.cntct_tel;
				document.querySelector("span#homepage_url").textContent = response.homepage_url;
				document.getElementById("link").href = response.homepage_url;
				
				// 지도와 마커를 추가하는 함수 호출
				initMap(response.lat, response.lng);
				
				checkIfLiked();
			},
			error: function(error){
				console.log("Error: " + error);
			} 
		});
		
		getLikeCount();
		
		var authValue = localStorage.getItem("Authorization");
		if(authValue != null){
			$(".hiddenButton").css("display", "block");
		}
	});
	
	function initMap(lat, lng) {
        var location = { lat: parseFloat(lat), lng: parseFloat(lng) };
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 15,
            center: location
        });
        var marker = new google.maps.Marker({
            position: location,
            map: map
        });
    }

	function modifyFoodTour(){
		window.location.href="/modi_food?uc_seq=" + uc_seq;
	}
	
	function deletethisPage(){
		if(confirm("이 게시글을 삭제하시겠습니까?") == true){
			console.log("아이디 확인: " + uc_seq);
			
			const token = localStorage.getItem("Authorization");
			console.log("토큰: " + token);
			
			$.ajax({
				url: "http://localhost:9002/kibTest/food/" + uc_seq,
				method: "DELETE",
				headers: {
					"Authorization" : "Bearer " + token
				},
				success: function(response){
					console.log("응답: " + response);
					alert(response);
					window.location.href="/foodList";
				},
				error: function(xhr, error, status){
					console.log("Error: " + error);
				}
			});
		} else {
			console.log("삭제 취소함");
			alert("삭제 취소함");
		}
	}
	
	function doLike(){
		console.log("dolike uc_seq...." + uc_seq);
		
		let likeYN = localStorage.getItem("Like"+ uc_seq);
		console.log(likeYN);
		
		const heartIcon = document.querySelector(".heart-icon");
		
		if(likeYN == null){
			
			localStorage.setItem("Like" + uc_seq, uc_seq);
			let likeToken = localStorage.getItem('Like' + uc_seq);
			
			$.ajax({
				url: "http://localhost:9002/like/doFoodLike/" + uc_seq,
				method: "POST",
				success: function(response){
					console.log(response);
					alert(response);
					heartIcon.classList.add("liked");
					
					getLikeCount();
				},
				error: function(xhr, status, error){
					console.log("Error: " + error);
				}
			});
		} else {
			
			$.ajax({
				url: "http://localhost:9002/like/deleteLikeFood/" + uc_seq,
				type: "DELETE",
				success: function(response){
					console.log("응답확인: " + response);
					alert(response);
					
					localStorage.removeItem("Like" + uc_seq);
					
					heartIcon.classList.remove("liked");
					
					getLikeCount();
				},
				error: function(xhr, status, error) {
					console.log("Error: " + error);
				}
			});
		}
	}
	
	function getLikeCount(){
		$.ajax({
			url: "http://localhost:9002/like/foodlike/" + uc_seq,
			method: "GET",
			success: function(response) {
				console.log("찾아온 좋아요 수 : " + response);
				
				if(response == ''){
					document.querySelector("#likecount").textContent = 0;
				} else {
					document.querySelector("#likecount").textContent = response;
				}
			},
			error: function(error){
				cosole.log("Erorr: " + error);
			}
		});
	}
	
	function checkIfLiked(){
		let likeYN = localStorage.getItem("Like" + uc_seq);
		
		console.log("페이지 로드 시 좋아요 키값: " + likeYN);
		const heartIcon = document.querySelector(".heart-icon");
		
		if (likeYN != null){
			heartIcon.classList.add('liked');
		}else {
			heartIcon.classList.remove('liked');
		}
	}
</script>

</body>
</html>

