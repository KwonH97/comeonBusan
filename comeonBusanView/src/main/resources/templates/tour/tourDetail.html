<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>관광지 상세페이지</title>
<script src="https://code.jquery.com/jquery-3.7.1.js"
	integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
	crossorigin="anonymous"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1VqsvOxs4dsglMk3wCxxB-_y58G3zyzU"></script> <!-- Google Maps API 스크립트 추가 -->
<style>
	#placeInfo{
		border: 2px solid #D88FD8;
		padding: 10px;
		margin: 20px 0;
		display: flex;
		flex-wrap: wrap;
		gap: 10px;
	}
	.info-group{
		flex: 1;
		gap: 5px;
	}
	.info-group:last-child {
		margin-right: 0;
	}
	.info-group span{
		display: block;
		margin-bottom: 5px;
	}
	.info-section{
		display: flex;
		justify-content: space-between;
		margin-bottom: 10px;
	}
	.single-info{
		margin-bottom: 10px;
	}
	.addr .tel .homepage_url .dayInfo .useageDay_week_and_time .usage_amount .middle_size_rm .trfc_info{
		margin-bottom: 10px;
	}
	.info{
		color: blue;
		font-size: 30px;
	}
	#map {
		height: 500px; /* 원하는 높이로 설정 */
		width: 100%; /* 원하는 너비로 설정 */
		margin: 20px 0; /* 위아래 여백 설정 */
	}
	
	.heart-button {
	background-color: transparent;
	border: none;
	cursor: pointer;
	outline: none;
	padding: 0;
	width: 50px;
	height: 50px;
}

.heart-icon {
	fill: transparent;
	stroke: black;
	stroke-width: 1; /*테두리 더 굴게 얇게 조정*/
	transition: transform 0.2s;
}

.heart-button:hover .heart-icon {
	transform: scale(1.1);
}

.heart-icon.liked {
	fill: red;
	stroke: red;
}
</style>
</head>
<body>
<header>
        <th:block th:insert="~{/fragments/header2.html}"></th:block>
</header>
<h1>관광지 상세페이지</h1>
<hr>

<button class="hiddenButton" style="display: none;" onclick="gomodifyPage()">수정하기</button>
<button class="hiddenButton" style="display: none;" onclick="deleteThisPage()">삭제하기</button>

<div class="container">
	<h3 id="title"></h3>
	<h4 id="subtitle"></h4>
	<h4 id="place"></h4>
	<img id="main_img" alt="관광지 홍보사진"><br>
	조회수 : <span id="viewcount"></span><br>
	<button class="heart-button" onclick="doLike()">
		<svg class="heart-icon" viewBox="0 0 24 24" width="50" height="50">
				<path
					d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
			</svg>
	</button>
	<span>( </span><span id="likecount"></span><span> )</span><br>
	<p><button onclick="loadBlogPage(uc_seq)">리뷰보기</button></p>
	<span class="info">관광지 배경</span><br>
	<div id="itemcntnts"><!-- 관광지 설명 --></div>
	
	 <!--  
	<div id="video-container"></div>
	<video style="width:100%;" src="https://vod.visitbusan.net:8080/upload/encoding/video/2024/06/c0a49b6312a84e2ea5a74ec9efd3f293_media_1280x720.mp4" controls="" controlslist="nodownload" loop="" playsinline="" poster="https://vod.visitbusan.net:8080//upload/encoding/video/2024/06/c0a49b6312a84e2ea5a74ec9efd3f293_mplayer1_3.png"> Sorry, your browser doesn't support embedded videos,
 but don't worry, you can <a href="videofile.ogg">download it</a> and watch it with your favorite video player!
	</video>
	-->
	
	<div id="placeInfo">
		<div class="info-section">
			<div class="info-group">
				<span class="info">주소: </span><span class="addr"></span>
				<span class="info">연락처: </span><span class="tel"></span>
				<span class="info">홈페이지: </span><span class="homepage_url"></span><br>
			</div>
			<div class="info-group">
				<span class="info">운영일~휴무일: </span><span class="dayInfo"></span>
				<span class="info">운영 및 시간: </span><span class="useageDay_week_and_time"></span>
				<span class="info">이용요금: </span><span class="usage_amount"></span><br>
			</div>
		</div>
		<div class="single-info">
			<span class="info">편의 시설: </span><br>
			<span class="middle_size_rm"></span>
		</div>
		<div class="single-info">
			<span class="info">교통정보: </span><br>
			<span class="trfc_info"></span>
		</div>
	</div>
	<div id="map"></div> <!-- 지도를 표시할 div 추가 -->
</div>
  <footer>
    <th:block th:insert="~{/fragments/footer.html}"></th:block>
  </footer>
<script>
	var uc_seq = "[[${uc_seq}]]";
	
	function loadBlogPage(lid) {
        window.location.href = `/blog?uc_seq=${uc_seq}`;
    }
	
	$(document).ready(function(){
		console.log("id값: " + uc_seq);
		
// 		// 조회수 증가 요청 보내기
// 		$.ajax({
// 			url: 'http://localhost:9002/views/tour/' + uc_seq,
// 			method: 'POST',
// 			success: function() {
// 				console.log("View count incremented");
// 			},
// 			error: function(error) {
// 				console.error("Error incrementing view count: " + error);
// 			}
// 		});

// 		// 조회수 가져오기
// 		$.ajax({
// 			url: 'http://localhost:9002/views/tour/' + uc_seq,
// 			method: 'GET',
// 			success: function(viewCount) {
// 				console.log("Current view count: " + viewCount);
// 				document.querySelector("#viewcount").textContent = viewCount;
// 			},
// 			error: function(error) {
// 				console.error("Error fetching view count: " + error);
// 			}
// 		});
		
		$.ajax({
			url: "http://localhost:9002/kibTest/tour/" + uc_seq,
			method: "GET",
			success: function(response){
				// response 데이터 저장
				const title = response.title;
				const subtitle = response.subtitle;
				const place = response.place;
				const main_img_normal = response.main_img_normal;
				const itemcntnts = response.itemcntnts;
				const addr = response.addr;
				const lat = response.lat; // 위도
				const lng = response.lng; // 경도
				
				document.querySelector("h3#title").textContent = title;
				document.querySelector("h4#subtitle").textContent = subtitle;
				document.querySelector("h4#place").textContent = place;
				
				document.querySelector("img#main_img").src = main_img_normal;
				document.querySelector("div#itemcntnts").innerHTML = itemcntnts;
				
				//div.placeinfo 속 요소들 설정
				document.querySelector("span.addr").textContent = addr;
				document.querySelector("span.tel").textContent = response.tel;
				document.querySelector("span.homepage_url").innerHTML = response.homepage_url;
				
				document.querySelector("span.dayInfo").textContent = "운영일: " + response.usage_day + " / 휴무일: " + response.hldy_info;
				document.querySelector("span.useageDay_week_and_time").textContent = response.useageDay_week_and_time;
				document.querySelector("span.usage_amount").textContent = response.usage_amount;
				
				document.querySelector("span.middle_size_rm").textContent = response.middle_size_rm;
				document.querySelector("span.trfc_info").textContent = response.trfc_info;
				
				// 지도와 마커를 추가하는 함수 호출
				initMap(lat, lng);
				
				checkIfLiked();
				
			},
			error: function(error){
				console.log("Error: " + error);
			}
		});
		
		getLikeCount();
		
		var authValue = localStorage.getItem("Authorization");
		if(authValue != null){
			$(".hiddenButton").css("display", "block");
		}
	});
	
	function initMap(lat, lng) {
		var location = { lat: parseFloat(lat), lng: parseFloat(lng) };
		var map = new google.maps.Map(document.getElementById('map'), {
			zoom: 15,
			center: location
		});
		var marker = new google.maps.Marker({
			position: location,
			map: map
		});
	}

	function gomodifyPage() {
		window.location.href = "/modi_tour?uc_seq=" + uc_seq;
	}
	
	function deleteThisPage(){
		
		if(confirm("이 게시글을 삭제하시겠습니까?") == true){
			cosole.log("아이디 확인: " + uc_seq);
			
			const token = localStorage.getItem("Authorization");
			console.log("토큰: " + token);
			
			$.ajax({
				url: "http://localhost:9002/kibTest/tour/" + uc_seq,
				method: "DELETE",
				headers: {
					"Authorization" : "Bearer " + token
				},
				success: function(response){
					console.log("응답: " + response);
					alert(response);
				},
				error: function(xhr, error, status){
					console.log("Error: " + error);
				}
			});
		} else {
			console.log("삭제 취소함");
			alert("삭제 취소함");
		}
	}
	
	function doLike(){
		console.log("doLike uc_seq....." + uc_seq); //좋아요 할 컨텐츠ID 확인
		
		let likeYN = localStorage.getItem("Like" + uc_seq);
		console.log(likeYN);
		
		const heartIcon = document.querySelector(".heart-icon");
		
		if(likeYN == null){
			//좋아요를 누르면 토큰 발급
			localStorage.setItem("Like" + uc_seq, uc_seq);
			let likeToken = localStorage.getItem("Like" + uc_seq);
			
			$.ajax({
				type: "POST",
				url: "http://localhost:9002/like/doLikeTour/" + uc_seq,
				success: function(response){
					console.log(response);
					alert(response);
					heartIcon.classList.add('liked');
					
					getLikeCount();
				},
				error: function(xhr, status, error){
					console.log("Error: ", error);
				}
			});
		} else {
			//좋아요 취소
			$.ajax({
				type:"DELETE",
				url: "http://localhost:9002/like/deleteLikeTour/" + uc_seq,
				success: function(response) {
					console.log(response);
					alert(response);
					//local 저장된 좋아요토큰 삭제
					localStorage.removeItem("Like" + uc_seq);
					
					heartIcon.classList.remove("liked");
					
					//좋아요 수 업데이트
					getLikeCount();
				},
				error: function(xhr, status, error){
					console.log("Error: " + error);
				}
			});
		}
	}
	
	function getLikeCount(){
		$.ajax({
			url: "http://localhost:9002/like/GetlikeTour/" + uc_seq,
			method: "GET",
			success: function(response){
				console.log("찾아온 좋아요 수 " + response);
				
				if(response == ''){
					document.querySelector("#likecount").textContent = 0;
				} else {
					document.querySelector("#likecount").textContent = response;
				}
			},
			error: function(error) {
				console.log("Error: " + error);
			}
		});
	}
	
	function checkIfLiked(){
		let likeYN = localStorage.getItem("Like" + uc_seq);
		
		console.log("페이지 로드시 좋아요 키값: " + likeYN);
		const heartIcon = document.querySelector('.heart-icon');
		
		if (likeYN != null) {
			heartIcon.classList.add('liked');
		}else {
			heartIcon.classList.remove('liked');
		}
	}
</script>


</body>
</html>
